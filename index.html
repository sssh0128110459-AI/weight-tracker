<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>體重紀錄</title>

  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    /* ===== iOS Font ===== */
    body {
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", Arial, sans-serif;
      margin: 0;
      padding: 0;
      background: #f7f4ec; /* 淡淡的米黃色，比較像 iOS 背景 */
      overflow-x: hidden;
    }

    /* ===== Center Body Wrapper ===== */
    #main {
      opacity: 0;
      transition: opacity 1.2s ease;
      max-width: 520px;
      margin: auto;
      padding: 20px;
    }

    /* ===== Header Title ===== */
    h1 {
      font-size: 26px;
      font-weight: 700;
      color: #3b3025;
      text-align: center;
      margin: 10px 0 20px;
    }

    /* ===== iOS Card Style ===== */
    .card {
      background: #ffffff;
      border-radius: 18px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      padding: 18px 20px;
      margin-bottom: 20px;
    }

    /* ===== Input Field ===== */
    .input-area {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    input {
      padding: 12px;
      font-size: 17px;
      border-radius: 12px;
      border: 1px solid #d7d1c7;
      background: #fafafa;
      outline: none;
    }

    input:focus {
      border-color: #c2a86d;
      box-shadow: 0 0 0 3px rgba(248,206,126,0.35);
    }

    /* ===== iOS Button ===== */
    button {
      padding: 12px;
      font-size: 17px;
      font-weight: 600;
      border-radius: 12px;
      border: none;
      background: #f0c96a;
      color: #4a3510;
      cursor: pointer;
      transition: 0.15s;
    }
    button:active {
      transform: scale(0.97);
      background: #e7ba4c;
    }

    /* ===== Latest Info Auto Scale ===== */
    #latest {
      font-weight: 700;
      font-size: 19px;
      color: #3b3025;
      white-space: nowrap;
      transform-origin: left;
      display: inline-block;
      max-width: 100%;
    }

    #latest.auto-scale {
      transform: scale(var(--scale));
    }

    #weeklyStats {
      font-size: 14px;
      margin-top: 8px;
      color: #5a4d38;
      line-height: 1.45;
    }

    /* ===== Chart Wrapper ===== */
    #chartWrapper {
      background: #ffffff;
      border-radius: 18px;
      padding: 10px;
      overflow-x: auto;
    }

    /* ===== Record List ===== */
    .record {
      background: #ffffff;
      border-radius: 14px;
      padding: 14px 16px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.06);
      margin-bottom: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .record-text {
      font-size: 15px;
      font-weight: 500;
      color: #4f4436;
      white-space: nowrap;
    }

    .record-actions {
      display: flex;
      gap: 6px;
    }
    .edit-btn {
      padding: 4px 8px;
      font-size: 12px;
      border-radius: 8px;
      background: #f0c96a;
      border: none;
      color: #4a3510;
    }
    .delete-btn {
      padding: 4px 8px;
      font-size: 12px;
      border-radius: 8px;
      background: #ef7b7b;
      border: none;
      color: white;
    }

    /* ===== Modal (iOS Style) ===== */
    #modalOverlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.45);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 10000;
      backdrop-filter: blur(2px);
    }

    #modal {
      width: 90%;
      max-width: 360px;
      background: #fff;
      border-radius: 20px;
      padding: 20px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.25);
    }

    #modal h2 {
      margin: 0 0 14px;
      text-align: center;
      font-size: 20px;
    }

    .modal-row {
      margin-bottom: 14px;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .modal-btns {
      display: flex;
      gap: 12px;
      margin-top: 12px;
    }
    .btn-cancel {
      flex: 1;
      background: #e5ded0;
      border-radius: 12px;
      padding: 12px;
      border: none;
    }
    .btn-save {
      flex: 1;
      background: #f0c96a;
      border-radius: 12px;
      padding: 12px;
      border: none;
    }

    /* ===== Splash ===== */
    #splash {
      position: fixed;
      inset: 0;
      background: #f2e7c7;
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 999999;
      opacity: 1;
      transition: opacity 0.8s ease;
    }
    #splash-logo {
      font-size: 32px;
      font-weight: 700;
      color: #3b3025;
      opacity: 0;
      animation: splashIn 1s forwards;
    }
    @keyframes splashIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
  </style>
</head>

<body>

<!-- ===== Splash ===== -->
<div id="splash">
  <div id="splash-logo">體重紀錄</div>
</div>

<!-- ===== MAIN ===== -->
<div id="main">

  <h1>體重紀錄</h1>

  <div class="card">
    <div class="input-area">
      <input id="dateInput" type="date">
      <input id="weightInput" type="number" step="0.1" placeholder="體重 (kg)">
      <input id="fatInput" type="number" step="0.1" placeholder="體脂 (%)（可選填）">
      <button onclick="addRecord()">新增紀錄</button>
    </div>
  </div>

  <div class="card">
    <div id="latest"></div>
    <div id="weeklyStats"></div>
  </div>

  <div id="chartWrapper" class="card">
    <canvas id="weightChart"></canvas>
  </div>

  <div id="records"></div>

</div>

<!-- ===== MODAL ===== -->
<div id="modalOverlay">
  <div id="modal">
    <h2>編輯紀錄</h2>

    <div class="modal-row">
      <label>日期：</label>
      <input id="editDate" type="date">
    </div>
    <div class="modal-row">
      <label>體重 (kg)：</label>
      <input id="editWeight" type="number" step="0.1">
    </div>
    <div class="modal-row">
      <label>體脂 (%)：</label>
      <input id="editFat" type="number" step="0.1">
    </div>

    <div class="modal-btns">
      <button class="btn-cancel" onclick="closeModal()">取消</button>
      <button class="btn-save" onclick="saveEdit()">儲存</button>
    </div>
  </div>
</div>

<script>
/* ===== Storage ===== */
const STORAGE_KEY = "weight_logs";
let editIndex = null;
let chart = null;

function getLogs() {
  return JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]");
}
function saveLogs(logs) {
  localStorage.setItem(STORAGE_KEY, JSON.stringify(logs));
}

/* ===== Splash Animation ===== */
window.addEventListener("load", () => {
  const splash = document.getElementById("splash");
  const main = document.getElementById("main");

  setTimeout(() => {
    main.style.opacity = 1;
    splash.style.opacity = 0;

    setTimeout(() => {
      splash.style.display = "none";
    }, 900);
  }, 1200);
});

/* ===== Auto Today ===== */
function setDefaultDate() {
  const d = document.getElementById("dateInput");
  if (!d.value) {
    d.value = new Date().toISOString().slice(0, 10);
  }
}

/* ===== Add Record ===== */
function addRecord() {
  const date = dateInput.value || new Date().toISOString().slice(0, 10);
  const w = weightInput.value;
  const f = fatInput.value;

  if (!w) {
    alert("請輸入體重！");
    return;
  }

  const logs = getLogs();
  logs.push({ date, weight: w, fat: f });
  saveLogs(logs);

  weightInput.value = "";
  fatInput.value = "";

  render();
}

/* ===== Auto Scale Latest ===== */
function autoScaleLatest() {
  const el = document.getElementById("latest");
  const parentWidth = el.parentElement.clientWidth;

  el.style.setProperty("--scale", 1);
  el.classList.add("auto-scale");

  const scale = parentWidth / el.scrollWidth;
  el.style.setProperty("--scale", Math.min(scale, 1));
}

/* ===== Latest & Weekly ===== */
function showLatest() {
  const logs = getLogs();
  const latestDiv = document.getElementById("latest");

  if (logs.length === 0) {
    latestDiv.innerText = "尚無紀錄";
    return;
  }

  const sorted = logs.slice().sort((a,b)=>b.date.localeCompare(a.date));
  const last = sorted[0];

  let text = `${last.date}：${last.weight} kg`;
  if (last.fat) text += `，體脂 ${last.fat}%`;

  latestDiv.innerText = text;
  autoScaleLatest();
}

/* ===== Chart ===== */
function renderChart() {
  const logs = getLogs();
  if (!logs.length) return;

  const byDate = {};

  logs.forEach(l=>{
    if (!byDate[l.date]) {
      byDate[l.date] = { w: [], f: [] };
    }
    byDate[l.date].w.push(parseFloat(l.weight));
    if (l.fat) byDate[l.date].f.push(parseFloat(l.fat));
  });

  const dates = Object.keys(byDate).sort();
  const weights = dates.map(d => 
    byDate[d].w.reduce((a,b)=>a+b)/byDate[d].w.length
  );
  const fats = dates.map(d =>
    byDate[d].f.length ? byDate[d].f.reduce((a,b)=>a+b)/byDate[d].f.length : null
  );

  const canvas = document.getElementById("weightChart");
  canvas.width = Math.max(300, dates.length * 70);

  const ctx = canvas.getContext("2d");

  if (chart) chart.destroy();

  chart = new Chart(ctx, {
    type: "line",
    data: {
      labels: dates,
      datasets: [
        {
          label: "體重",
          data: weights,
          borderWidth: 2,
          tension: 0.25,
          pointRadius: 4
        },
        {
          label: "體脂",
          data: fats,
          borderWidth: 2,
          borderColor: "#f3c23a",
          backgroundColor: "rgba(243,194,58,0.2)",
          tension: 0.25,
          pointRadius: 4
        }
      ]
    }
  });
}

/* ===== Render Records ===== */
function renderRecords() {
  const logs = getLogs();
  const box = document.getElementById("records");
  box.innerHTML = "";

  const sorted = logs.slice().sort((a,b)=>b.date.localeCompare(a.date));

  sorted.forEach(l=>{
    const idx = logs.indexOf(l);

    const div = document.createElement("div");
    div.className = "record";

    const text = document.createElement("div");
    text.className = "record-text";
    text.innerText = `${l.date}  |  ${l.weight}kg ${l.fat?` | 體脂${l.fat}%`:""}`;

    const actions = document.createElement("div");
    actions.className = "record-actions";

    const eBtn = document.createElement("button");
    eBtn.className = "edit-btn";
    eBtn.innerText = "編輯";
    eBtn.onclick = ()=>openModal(idx);

    const dBtn = document.createElement("button");
    dBtn.className = "delete-btn";
    dBtn.innerText = "刪除";
    dBtn.onclick = ()=>deleteRecord(idx);

    actions.append(eBtn,dBtn);

    div.append(text,actions);
    box.append(div);
  });
}

/* ===== Modal ===== */
function openModal(index) {
  editIndex = index;
  const logs = getLogs();
  const l = logs[index];

  editDate.value = l.date;
  editWeight.value = l.weight;
  editFat.value = l.fat;

  modalOverlay.style.display = "flex";
}

function closeModal() {
  modalOverlay.style.display = "none";
}

function saveEdit() {
  const logs = getLogs();
  const l = logs[editIndex];

  l.date = editDate.value;
  l.weight = editWeight.value;
  l.fat = editFat.value;

  saveLogs(logs);
  closeModal();
  render();
}

function deleteRecord(index) {
  if (!confirm("確定刪除？")) return;
  const logs = getLogs();
  logs.splice(index,1);
  saveLogs(logs);
  render();
}

/* ===== Render Root ===== */
function render() {
  renderRecords();
  renderChart();
  showLatest();
  weeklyStats.innerText = "";
}

/* ===== Start ===== */
setDefaultDate();
render();

</script>

</body>
</html>
