<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>Weight Record</title>

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="theme-color" content="#f7f4ec" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root {
      --bg-color: #f7f4ec;
      --text-main: #3b3025;
      --card-bg: #ffffff;
      --card-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
      --border-subtle: #d7d1c7;
      --input-bg: #fafafa;
      --accent: #f0c96a;
      --accent-dark: #e7ba4c;
      --danger: #ef7b7b;
      --muted: #5a4d38;
    }

    body.dark-mode {
      --bg-color: #151515;
      --text-main: #f5f1e6;
      --card-bg: #222222;
      --card-shadow: 0 4px 16px rgba(0, 0, 0, 0.6);
      --border-subtle: #444444;
      --input-bg: #333333;
      --accent: #e7ba4c;
      --accent-dark: #d3a63b;
      --danger: #f07171;
      --muted: #c4b8a3;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI",
        Arial, sans-serif;
      margin: 0;
      padding: 0;
      background: var(--bg-color);
      color: var(--text-main);
      overflow-x: hidden;
    }

    #main {
      opacity: 0;
      transition: opacity 1.2s ease;
      max-width: 520px;
      margin: auto;
      padding: 16px 16px 24px;
    }

    .top-bar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin: 8px 0 16px;
    }

    h1 {
      font-size: 24px;
      font-weight: 700;
      margin: 0;
    }

    .top-right {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .icon-btn {
      width: 34px;
      height: 34px;
      border-radius: 999px;
      border: 1px solid var(--border-subtle);
      background: var(--card-bg);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      cursor: pointer;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
      padding: 0;
    }

    .card {
      background: var(--card-bg);
      border-radius: 18px;
      box-shadow: var(--card-shadow);
      padding: 16px 16px;
      margin-bottom: 16px;
      border: 1px solid rgba(0, 0, 0, 0.03);
    }

    .input-area {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    input {
      padding: 10px 12px;
      font-size: 16px;
      border-radius: 12px;
      border: 1px solid var(--border-subtle);
      background: var(--input-bg);
      outline: none;
      color: var(--text-main);
      box-sizing: border-box;
    }

    input:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(248, 206, 126, 0.35);
    }

    button {
      padding: 10px 12px;
      font-size: 16px;
      font-weight: 600;
      border-radius: 12px;
      border: none;
      background: var(--accent);
      color: #4a3510;
      cursor: pointer;
      transition: 0.15s;
    }

    button:active {
      transform: scale(0.97);
      background: var(--accent-dark);
    }

    .btn-row {
      display: flex;
      gap: 8px;
      margin-top: 8px;
    }

    .btn-secondary {
      background: var(--card-bg);
      color: var(--muted);
      border: 1px solid var(--border-subtle);
    }

    .btn-secondary:active {
      background: var(--input-bg);
    }

    .btn-danger-ghost {
      background: var(--card-bg);
      color: var(--danger);
      border: 1px solid rgba(239,123,123,0.5);
    }

    #latest {
      font-weight: 700;
      font-size: 19px;
      white-space: nowrap;
      transform-origin: left;
      display: inline-block;
      max-width: 100%;
    }

    #latest.auto-scale {
      transform: scale(var(--scale));
    }

    #weeklyStats {
      font-size: 13px;
      margin-top: 6px;
      color: var(--muted);
      line-height: 1.5;
      white-space: pre-line;
    }

    #chartWrapper {
      border-radius: 18px;
      padding: 10px;
      overflow-x: auto;
      background: var(--card-bg);
      box-shadow: var(--card-shadow);
    }

    #weightChart {
      display: block;
    }

    /* æŒ‡æ¨™åˆ‡æ› tab */
    .metric-tabs {
      display: flex;
      gap: 6px;
      margin-bottom: 8px;
      flex-wrap: wrap;
    }

    .metric-tab {
      flex: 0 0 auto;
      padding: 4px 10px;
      font-size: 12px;
      border-radius: 999px;
      border: 1px solid var(--border-subtle);
      background: var(--card-bg);
      color: var(--muted);
      cursor: pointer;
    }

    .metric-tab.active {
      background: var(--accent);
      color: #4a3510;
      border-color: var(--accent-dark);
    }

    #records {
      margin-top: 6px;
    }

    .record {
      background: var(--card-bg);
      border-radius: 14px;
      padding: 8px 10px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.06);
      margin-bottom: 6px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      border: 1px solid rgba(0, 0, 0, 0.02);
    }

    .record-text {
      font-size: 13px;
      font-weight: 500;
      color: var(--text-main);
      white-space: nowrap;
    }

    .record-actions {
      display: flex;
      gap: 4px;
      flex-shrink: 0;
    }

    .edit-btn,
    .delete-btn {
      padding: 3px 6px;
      font-size: 11px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      min-width: 40px;
    }

    .edit-btn {
      background: var(--accent);
      color: #4a3510;
    }

    .delete-btn {
      background: var(--danger);
      color: white;
    }

    /* æœˆä»½ç¾¤çµ„ header */
    .month-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .month-title {
      font-size: 15px;
      font-weight: 600;
    }

    .month-toggle {
      font-size: 12px;
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid var(--border-subtle);
      background: var(--card-bg);
      color: var(--muted);
      cursor: pointer;
    }

    /* ç·¨è¼¯ç´€éŒ„ Modal */
    #modalOverlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.45);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 10000;
      backdrop-filter: blur(3px);
    }

    #modal {
      width: 90%;
      max-width: 360px;
      background: var(--card-bg);
      border-radius: 20px;
      padding: 18px 18px 16px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.35);
      border: 1px solid rgba(0, 0, 0, 0.08);
    }

    #modal h2 {
      margin: 0 0 10px;
      text-align: center;
      font-size: 18px;
    }

    .modal-row {
      margin-bottom: 10px;
      display: flex;
      flex-direction: column;
      gap: 4px;
      font-size: 14px;
    }

    .modal-btns {
      display: flex;
      gap: 10px;
      margin-top: 10px;
    }

    .btn-cancel {
      flex: 1;
      background: var(--card-bg);
      color: var(--muted);
      border-radius: 12px;
      padding: 10px;
      border: 1px solid var(--border-subtle);
    }

    .btn-save {
      flex: 1;
      background: var(--accent);
      color: #4a3510;
      border-radius: 12px;
      padding: 10px;
      border: none;
    }

    /* Profile Modal */
    #profileOverlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.45);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 10001;
      backdrop-filter: blur(3px);
    }

    #profileModal {
      width: 90%;
      max-width: 360px;
      background: var(--card-bg);
      border-radius: 20px;
      padding: 18px 18px 16px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.35);
      border: 1px solid rgba(0, 0, 0, 0.08);
    }

    #profileModal h2 {
      margin: 0 0 10px;
      text-align: center;
      font-size: 18px;
    }

    .gender-row {
      display: flex;
      gap: 12px;
      font-size: 14px;
      align-items: center;
    }

    .gender-row label {
      display: flex;
      align-items: center;
      gap: 4px;
      cursor: pointer;
    }

    #profileBMI {
      margin-top: 4px;
      font-size: 13px;
      color: var(--muted);
      line-height: 1.5;
      white-space: pre-line;
    }

    /* BMI é•·æ©¢åœ“æ¢ + ä¸‰è§’å½¢æŒ‡æ¨™ */
    .bmi-bar-container {
      margin-top: 6px;
      margin-bottom: 2px;
    }

    .bmi-bar-wrapper {
      position: relative;
      width: 100%;
      height: 26px;
    }

    .bmi-bar {
      position: absolute;
      left: 0;
      right: 0;
      top: 5px;
      height: 12px;
      border-radius: 999px;
      overflow: hidden;
      display: flex;
      border: 1px solid rgba(0,0,0,0.08);
    }

    .bmi-seg {
      flex: 1;
    }
    .bmi-low {
      background: #6ca8ff;
    }
    .bmi-mid {
      background: #fdfdfd;
    }
    .bmi-high {
      background: #ff7b7b;
    }

    .bmi-pointer {
      position: absolute;
      bottom: 0;
      width: 0;
      height: 0;
      border-left: 6px solid transparent;
      border-right: 6px solid transparent;
      border-top: 8px solid #3b3025;
      transform: translateX(-50%);
      display: none;
    }

    /* å´æ¬„ï¼šåŒ¯å‡º / åŒ¯å…¥ */
    #exportOverlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.35);
      display: none;
      justify-content: flex-end;
      align-items: stretch;
      z-index: 10002;
      backdrop-filter: blur(2px);
    }

    #exportPanel {
      width: 85%;
      max-width: 360px;
      background: var(--card-bg);
      border-left: 1px solid var(--border-subtle);
      box-shadow: -4px 0 18px rgba(0,0,0,0.25);
      padding: 16px 14px 14px;
      display: flex;
      flex-direction: column;
      box-sizing: border-box;
    }

    .export-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
      font-size: 15px;
      font-weight: 600;
    }

    .export-close {
      border: none;
      background: transparent;
      font-size: 18px;
      cursor: pointer;
      color: var(--muted);
      padding: 4px;
    }

    #exportArea {
      width: 100%;
      min-height: 140px;
      font-size: 12px;
      padding: 6px 8px;
      border-radius: 10px;
      border: 1px solid var(--border-subtle);
      background: var(--input-bg);
      color: var(--text-main);
      resize: vertical;
      box-sizing: border-box;
    }

    .export-tip {
      font-size: 11px;
      color: var(--muted);
      margin-top: 8px;
      line-height: 1.4;
    }

    /* Splash */
    #splash {
      position: fixed;
      inset: 0;
      background: #f2e7c7;
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 999999;
      opacity: 1;
      transition: opacity 0.8s ease;
      backdrop-filter: blur(0px);
    }

    #splash-logo {
      font-size: 34px;
      font-weight: 700;
      color: #3b3025;
      opacity: 0;
      transform: scale(0.85) translateY(24px);
      filter: blur(8px);
      animation: splashFancy 1.2s ease forwards;
    }

    @keyframes splashFancy {
      0% {
        opacity: 0;
        transform: scale(0.85) translateY(24px);
        filter: blur(8px);
      }
      45% {
        opacity: 1;
        transform: scale(1.04) translateY(-4px);
        filter: blur(0px);
      }
      80% {
        opacity: 1;
        transform: scale(1) translateY(0);
        filter: blur(0px);
      }
      100% {
        opacity: 1;
        transform: scale(1) translateY(0);
        filter: blur(0px);
      }
    }
  </style>
</head>

<body>
  <!-- Splash -->
  <div id="splash">
    <div id="splash-logo">Weight Record</div>
  </div>

  <!-- Main -->
  <div id="main">
    <div class="top-bar">
      <h1>Weight Record</h1>
      <div class="top-right">
        <button class="icon-btn" id="profileBtn" title="å€‹äººè³‡æ–™">
          ğŸ‘¤
        </button>
        <button class="icon-btn" id="exportBtn" title="åŒ¯å‡º / åŒ¯å…¥" onclick="openExportPanel()">
          â‡„
        </button>
        <button class="icon-btn" id="themeToggle" title="åˆ‡æ›ä¸»é¡Œ">
          ğŸŒ™
        </button>
      </div>
    </div>

    <!-- è¼¸å…¥å€ -->
    <div class="card">
      <div class="input-area">
        <input id="dateInput" type="date" />
        <input
          id="weightInput"
          type="number"
          step="0.1"
          placeholder="é«”é‡ (kg)"
        />
        <input
          id="fatInput"
          type="number"
          step="0.1"
          placeholder="é«”è„‚ (%)ï¼ˆå¯é¸å¡«ï¼‰"
        />
        <input
          id="muscleInput"
          type="number"
          step="0.1"
          placeholder="éª¨éª¼è‚Œ (%)ï¼ˆå¯é¸å¡«ï¼‰"
        />
        <button onclick="addRecord()">æ–°å¢ç´€éŒ„</button>
      </div>
    </div>

    <!-- æœ€æ–°ç´€éŒ„ + é€±è®ŠåŒ– -->
    <div class="card">
      <div id="latest"></div>
      <div id="weeklyStats"></div>
    </div>

    <!-- åœ–è¡¨ -->
    <div id="chartWrapper" class="card">
      <div class="metric-tabs">
        <button class="metric-tab active" id="tabAll" onclick="setMetricMode('all')">å…¨éƒ¨</button>
        <button class="metric-tab" id="tabWeight" onclick="setMetricMode('weight')">é«”é‡</button>
        <button class="metric-tab" id="tabFat" onclick="setMetricMode('fat')">é«”è„‚</button>
        <button class="metric-tab" id="tabMuscle" onclick="setMetricMode('muscle')">éª¨éª¼è‚Œ</button>
      </div>
      <canvas id="weightChart"></canvas>
    </div>

    <!-- ç´€éŒ„åˆ—è¡¨ï¼ˆä¾æœˆä»½ç¾¤çµ„ï¼‰ -->
    <div id="records"></div>
  </div>

  <!-- ç·¨è¼¯ç´€éŒ„ Modal -->
  <div id="modalOverlay">
    <div id="modal">
      <h2>ç·¨è¼¯ç´€éŒ„</h2>

      <div class="modal-row">
        <label>æ—¥æœŸï¼š</label>
        <input id="editDate" type="date" />
      </div>
      <div class="modal-row">
        <label>é«”é‡ (kg)ï¼š</label>
        <input id="editWeight" type="number" step="0.1" />
      </div>
      <div class="modal-row">
        <label>é«”è„‚ (%)ï¼š</label>
        <input id="editFat" type="number" step="0.1" />
      </div>
      <div class="modal-row">
        <label>éª¨éª¼è‚Œ (%)ï¼š</label>
        <input id="editMuscle" type="number" step="0.1" />
      </div>

      <div class="modal-btns">
        <button class="btn-cancel" onclick="closeModal()">å–æ¶ˆ</button>
        <button class="btn-save" onclick="saveEdit()">å„²å­˜</button>
      </div>
    </div>
  </div>

  <!-- å€‹äººè³‡æ–™ï¼ˆæ€§åˆ¥ï¼‹èº«é«˜ï¼‹BMIï¼‰ Modal -->
  <div id="profileOverlay">
    <div id="profileModal">
      <h2>å€‹äººè³‡æ–™</h2>

      <div class="modal-row">
        <label>èº«é«˜ï¼ˆcmï¼‰ï¼š</label>
        <input id="profileHeight" type="number" step="0.1" placeholder="ä¾‹å¦‚ 170" />
      </div>

      <div class="modal-row">
        <label>æ€§åˆ¥ï¼š</label>
        <div class="gender-row">
          <label>
            <input type="radio" name="profileGender" value="male" /> ç”·
          </label>
          <label>
            <input type="radio" name="profileGender" value="female" /> å¥³
          </label>
        </div>
      </div>

      <div class="modal-row bmi-bar-container">
        <label>BMI æŒ‡æ¨™ï¼š</label>
        <div class="bmi-bar-wrapper">
          <div class="bmi-bar">
            <div class="bmi-seg bmi-low"></div>
            <div class="bmi-seg bmi-mid"></div>
            <div class="bmi-seg bmi-high"></div>
          </div>
          <div id="bmiPointer" class="bmi-pointer"></div>
        </div>
        <div id="profileBMI"></div>
      </div>

      <div class="modal-btns">
        <button class="btn-cancel" onclick="closeProfile()">å–æ¶ˆ</button>
        <button class="btn-save" onclick="saveProfileData()">å„²å­˜</button>
      </div>
    </div>
  </div>

  <!-- å´æ¬„ï¼šåŒ¯å‡º / åŒ¯å…¥ -->
  <div id="exportOverlay" onclick="if(event.target === this) closeExportPanel();">
    <div id="exportPanel">
      <div class="export-header">
        <span>åŒ¯å‡º / åŒ¯å…¥è³‡æ–™</span>
        <button class="export-close" onclick="closeExportPanel()">âœ•</button>
      </div>

      <textarea id="exportArea"></textarea>

      <div class="btn-row" style="margin-top: 8px;">
        <button class="btn-secondary" onclick="copyExport()">è¤‡è£½åŒ¯å‡ºå…§å®¹</button>
        <button class="btn-secondary" onclick="importFromText()">åŒ¯å…¥è²¼ä¸Šçš„è³‡æ–™</button>
      </div>
      <div class="btn-row" style="margin-top: 4px;">
        <button class="btn-danger-ghost" onclick="clearAll()">æ¸…é™¤å…¨éƒ¨ç´€éŒ„</button>
      </div>

      <div class="export-tip">
        åŒ¯å‡ºï¼šæŒ‰ã€Œè¤‡è£½åŒ¯å‡ºå…§å®¹ã€ï¼Œè²¼åˆ°é›²ç«¯è¨˜äº‹ / Line è‡ªå·±ã€‚<br />
        åŒ¯å…¥ï¼šåœ¨ä¸Šæ–¹è²¼ä¸Š JSONï¼Œå†æŒ‰ã€ŒåŒ¯å…¥è²¼ä¸Šçš„è³‡æ–™ã€ã€‚<br />
        â€» æ¯å°è£ç½®è³‡æ–™æ˜¯ç¨ç«‹çš„ï¼ŒåŒ¯å…¥æœƒè¦†è“‹ç›®å‰è³‡æ–™ã€‚
      </div>
    </div>
  </div>

  <script>
    const STORAGE_KEY = "weight_logs";
    const THEME_KEY = "weight_theme";
    const PROFILE_KEY = "weight_profile";
    let editIndex = null;
    let chart = null;
    let metricMode = "all"; // all | weight | fat | muscle

    function getLogs() {
      return JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]");
    }
    function saveLogs(logs) {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(logs));
    }

    function getProfile() {
      return JSON.parse(localStorage.getItem(PROFILE_KEY) || "{}");
    }
    function saveProfile(profile) {
      localStorage.setItem(PROFILE_KEY, JSON.stringify(profile));
    }

    window.addEventListener("load", () => {
      initTheme();
      setDefaultDate();

      const splash = document.getElementById("splash");
      const main = document.getElementById("main");

      setTimeout(() => {
        main.style.opacity = 1;
        splash.style.opacity = 0;
        setTimeout(() => {
          splash.style.display = "none";
        }, 900);
      }, 1200);

      render();
    });

    function initTheme() {
      const saved = localStorage.getItem(THEME_KEY);
      const btn = document.getElementById("themeToggle");
      if (saved === "dark") {
        document.body.classList.add("dark-mode");
        btn.innerText = "â˜€ï¸";
      } else {
        document.body.classList.remove("dark-mode");
        btn.innerText = "ğŸŒ™";
      }
    }

    document.getElementById("themeToggle").addEventListener("click", () => {
      document.body.classList.toggle("dark-mode");
      const isDark = document.body.classList.contains("dark-mode");
      localStorage.setItem(THEME_KEY, isDark ? "dark" : "light");
      document.getElementById("themeToggle").innerText = isDark ? "â˜€ï¸" : "ğŸŒ™";
    });

    document.getElementById("profileBtn").addEventListener("click", openProfile);

    function setDefaultDate() {
      const d = document.getElementById("dateInput");
      if (!d.value) d.value = new Date().toISOString().slice(0, 10);
    }

    function addRecord() {
      const dateInput = document.getElementById("dateInput");
      const weightInput = document.getElementById("weightInput");
      const fatInput = document.getElementById("fatInput");
      const muscleInput = document.getElementById("muscleInput");

      const date = dateInput.value || new Date().toISOString().slice(0, 10);
      const weight = weightInput.value;
      const fat = fatInput.value;
      const muscle = muscleInput.value;

      if (!weight) {
        alert("è«‹è¼¸å…¥é«”é‡ï¼");
        return;
      }

      const logs = getLogs();
      logs.push({ date, weight, fat, muscle });
      saveLogs(logs);

      weightInput.value = "";
      fatInput.value = "";
      if (muscleInput) muscleInput.value = "";
      render();
    }

    function autoScaleLatest() {
      const el = document.getElementById("latest");
      if (!el.textContent) return;

      el.style.setProperty("--scale", 1);
      el.classList.add("auto-scale");

      const parentWidth = el.parentElement.clientWidth;
      const scale = parentWidth / el.scrollWidth;
      const finalScale = Math.min(scale, 1);
      el.style.setProperty("--scale", finalScale);
    }

    function showLatest() {
      const logs = getLogs();
      const latestDiv = document.getElementById("latest");

      if (!logs.length) {
        latestDiv.textContent = "å°šç„¡ç´€éŒ„";
        autoScaleLatest();
        return;
      }

      const sorted = logs.slice().sort((a, b) => b.date.localeCompare(a.date));
      const last = sorted[0];
      let text = `${last.date}ï¼š${last.weight} kg`;
      if (last.fat) text += `ï¼Œé«”è„‚ ${last.fat}%`;
      if (last.muscle) text += `ï¼Œéª¨éª¼è‚Œ ${last.muscle}%`;

      latestDiv.textContent = text;
      autoScaleLatest();
    }

    function showWeeklyStats() {
      const logs = getLogs();
      const box = document.getElementById("weeklyStats");
      if (!logs.length) {
        box.textContent = "";
        return;
      }

      const dates = logs.map((l) => l.date).filter(Boolean).sort();
      const latestDateStr = dates[dates.length - 1];
      const latestDate = new Date(latestDateStr);

      function dayDiff(a, b) {
        return Math.floor((a - b) / (1000 * 60 * 60 * 24));
      }

      const curW = [];
      const prevW = [];
      const curF = [];
      const prevF = [];
      const curM = [];
      const prevM = [];

      logs.forEach((l) => {
        if (!l.date) return;
        const d = new Date(l.date);
        const diff = dayDiff(latestDate, d);
        const w = parseFloat(l.weight);
        const f = l.fat ? parseFloat(l.fat) : NaN;
        const m = l.muscle ? parseFloat(l.muscle) : NaN;

        if (diff >= 0 && diff <= 6) {
          if (!isNaN(w)) curW.push(w);
          if (!isNaN(f)) curF.push(f);
          if (!isNaN(m)) curM.push(m);
        } else if (diff >= 7 && diff <= 13) {
          if (!isNaN(w)) prevW.push(w);
          if (!isNaN(f)) prevF.push(f);
          if (!isNaN(m)) prevM.push(m);
        }
      });

      function avg(arr) {
        if (!arr.length) return null;
        return arr.reduce((a, b) => a + b, 0) / arr.length;
      }

      const curWA = avg(curW);
      const prevWA = avg(prevW);
      const curFA = avg(curF);
      const prevFA = avg(prevF);
      const curMA = avg(curM);
      const prevMA = avg(prevM);

      let lines = [];
      if (curWA !== null) {
        let line = `æœ€è¿‘ 7 å¤©å¹³å‡é«”é‡ï¼šç´„ ${curWA.toFixed(1)} kg`;
        if (prevWA !== null) {
          const diff = curWA - prevWA;
          const sign = diff > 0 ? "+" : "";
          line += `ï¼ˆè¼ƒå‰ 7 å¤© ${sign}${diff.toFixed(1)} kgï¼‰`;
        }
        lines.push(line);
      }
      if (curFA !== null) {
        let line = `æœ€è¿‘ 7 å¤©å¹³å‡é«”è„‚ï¼šç´„ ${curFA.toFixed(1)} %`;
        if (prevFA !== null) {
          const diff = curFA - prevFA;
          const sign = diff > 0 ? "+" : "";
          line += `ï¼ˆè¼ƒå‰ 7 å¤© ${sign}${diff.toFixed(1)} %ï¼‰`;
        }
        lines.push(line);
      }
      if (curMA !== null) {
        let line = `æœ€è¿‘ 7 å¤©å¹³å‡éª¨éª¼è‚Œï¼šç´„ ${curMA.toFixed(1)} %`;
        if (prevMA !== null) {
          const diff = curMA - prevMA;
          const sign = diff > 0 ? "+" : "";
          line += `ï¼ˆè¼ƒå‰ 7 å¤© ${sign}${diff.toFixed(1)} %ï¼‰`;
        }
        lines.push(line);
      }

      box.textContent = lines.join("\n");
    }

    function renderChart() {
      const logs = getLogs();
      if (!logs.length) {
        if (chart) {
          chart.destroy();
          chart = null;
        }
        return;
      }

      const byDate = {};
      logs.forEach((l) => {
        if (!l.date) return;
        if (!byDate[l.date]) byDate[l.date] = { w: [], f: [], m: [] };

        const w = parseFloat(l.weight);
        if (!isNaN(w)) byDate[l.date].w.push(w);

        if (l.fat) {
          const f = parseFloat(l.fat);
          if (!isNaN(f)) byDate[l.date].f.push(f);
        }

        if (l.muscle) {
          const m = parseFloat(l.muscle);
          if (!isNaN(m)) byDate[l.date].m.push(m);
        }
      });

      const dates = Object.keys(byDate).sort();
      if (!dates.length) return;

      const weights = dates.map(
        (d) => byDate[d].w.reduce((a, b) => a + b, 0) / byDate[d].w.length
      );
      const fats = dates.map((d) =>
        byDate[d].f.length
          ? byDate[d].f.reduce((a, b) => a + b, 0) / byDate[d].f.length
          : null
      );
      const muscles = dates.map((d) =>
        byDate[d].m.length
          ? byDate[d].m.reduce((a, b) => a + b, 0) / byDate[d].m.length
          : null
      );

      const canvas = document.getElementById("weightChart");
      canvas.width = Math.max(320, dates.length * 70);
      canvas.height = 240;

      const ctx = canvas.getContext("2d");
      if (chart) chart.destroy();

      const datasets = [];

      if (metricMode === "all" || metricMode === "weight") {
        datasets.push({
          label: "é«”é‡ (kg)",
          data: weights,
          borderWidth: 2,
          tension: 0.25,
          pointRadius: 4,
        });
      }

      if (metricMode === "all" || metricMode === "fat") {
        datasets.push({
          label: "é«”è„‚ (%)",
          data: fats,
          borderWidth: 2,
          tension: 0.25,
          pointRadius: 4,
          borderColor: "#f3c23a",
          backgroundColor: "rgba(243,194,58,0.2)",
        });
      }

      if (metricMode === "all" || metricMode === "muscle") {
        datasets.push({
          label: "éª¨éª¼è‚Œ (%)",
          data: muscles,
          borderWidth: 2,
          tension: 0.25,
          pointRadius: 4,
          borderColor: "#ff4b4b",
          backgroundColor: "rgba(255,75,75,0.2)",
        });
      }

      chart = new Chart(ctx, {
        type: "line",
        data: {
          labels: dates,
          datasets,
        },
        options: {
          responsive: false,
          maintainAspectRatio: false,
          spanGaps: true,
        },
      });
    }

    function setMetricMode(mode) {
      metricMode = mode;
      const tabs = {
        all: document.getElementById("tabAll"),
        weight: document.getElementById("tabWeight"),
        fat: document.getElementById("tabFat"),
        muscle: document.getElementById("tabMuscle"),
      };
      Object.keys(tabs).forEach((k) => {
        if (!tabs[k]) return;
        if (k === mode) tabs[k].classList.add("active");
        else tabs[k].classList.remove("active");
      });
      renderChart();
    }

    // ===== æœˆä»½ç¾¤çµ„çš„æ­·å²ç´€éŒ„ =====
    function renderRecords() {
      const logs = getLogs();
      const box = document.getElementById("records");
      box.innerHTML = "";

      if (!logs.length) {
        const empty = document.createElement("div");
        empty.className = "card";
        empty.textContent = "ç›®å‰å°šç„¡ç´€éŒ„ï¼Œè«‹å…ˆæ–°å¢ä¸€ç­†ã€‚";
        box.appendChild(empty);
        return;
      }

      const sorted = logs.slice().sort((a, b) => b.date.localeCompare(a.date));

      const groups = {};
      sorted.forEach((log) => {
        const dateStr = log.date || "";
        const monthKey = dateStr.length >= 7 ? dateStr.slice(0, 7) : "æœªçŸ¥";
        if (!groups[monthKey]) groups[monthKey] = [];
        groups[monthKey].push(log);
      });

      const monthKeys = Object.keys(groups).sort((a, b) => b.localeCompare(a));

      monthKeys.forEach((monthKey, idx) => {
        const monthLogs = groups[monthKey];
        const monthCard = document.createElement("div");
        monthCard.className = "card";

        const header = document.createElement("div");
        header.className = "month-header";

        const title = document.createElement("div");
        title.className = "month-title";
        if (monthKey === "æœªçŸ¥") {
          title.textContent = "æœªè¨­å®šæ—¥æœŸ";
        } else {
          const [y, m] = monthKey.split("-");
          title.textContent = `${y} å¹´ ${m} æœˆ`;
        }

        const toggleBtn = document.createElement("button");
        toggleBtn.className = "month-toggle";

        const body = document.createElement("div");

        if (idx === 0) {
          body.style.display = "block";
          toggleBtn.textContent = "æ”¶åˆ";
        } else {
          body.style.display = "none";
          toggleBtn.textContent = "å±•é–‹";
        }

        toggleBtn.onclick = () => {
          if (body.style.display === "none") {
            body.style.display = "block";
            toggleBtn.textContent = "æ”¶åˆ";
          } else {
            body.style.display = "none";
            toggleBtn.textContent = "å±•é–‹";
          }
        };

        header.appendChild(title);
        header.appendChild(toggleBtn);
        monthCard.appendChild(header);

        monthLogs.forEach((l) => {
          const all = getLogs();
          const idxInAll = all.indexOf(l);

          const div = document.createElement("div");
          div.className = "record";

          const t = document.createElement("div");
          t.className = "record-text";
          let text = `${l.date}ï½œ${l.weight} kg`;
          if (l.fat) text += `ï½œé«”è„‚ ${l.fat}%`;
          if (l.muscle) text += `ï½œéª¨éª¼è‚Œ ${l.muscle}%`;
          t.textContent = text;

          const actions = document.createElement("div");
          actions.className = "record-actions";

          const eBtn = document.createElement("button");
          eBtn.className = "edit-btn";
          eBtn.textContent = "ç·¨è¼¯";
          eBtn.onclick = () => openModal(idxInAll);

          const dBtn = document.createElement("button");
          dBtn.className = "delete-btn";
          dBtn.textContent = "åˆªé™¤";
          dBtn.onclick = () => deleteRecord(idxInAll);

          actions.appendChild(eBtn);
          actions.appendChild(dBtn);

          div.appendChild(t);
          div.appendChild(actions);
          body.appendChild(div);
        });

        monthCard.appendChild(body);
        box.appendChild(monthCard);
      });
    }

    function openModal(index) {
      editIndex = index;
      const logs = getLogs();
      const l = logs[index];
      document.getElementById("editDate").value = l.date;
      document.getElementById("editWeight").value = l.weight;
      document.getElementById("editFat").value = l.fat || "";
      document.getElementById("editMuscle").value = l.muscle || "";
      document.getElementById("modalOverlay").style.display = "flex";
    }

    function closeModal() {
      document.getElementById("modalOverlay").style.display = "none";
    }

    function saveEdit() {
      const logs = getLogs();
      const l = logs[editIndex];
      l.date = document.getElementById("editDate").value;
      l.weight = document.getElementById("editWeight").value;
      l.fat = document.getElementById("editFat").value;
      l.muscle = document.getElementById("editMuscle").value;
      if (!l.weight) {
        alert("é«”é‡ä¸å¯ç‚ºç©ºï¼");
        return;
      }
      saveLogs(logs);
      closeModal();
      render();
    }

    function deleteRecord(index) {
      if (!confirm("ç¢ºå®šè¦åˆªé™¤é€™ç­†ç´€éŒ„å—ï¼Ÿ")) return;
      const logs = getLogs();
      logs.splice(index, 1);
      saveLogs(logs);
      render();
    }

    /* ===== åŒ¯å‡º / åŒ¯å…¥ / æ¸…é™¤ ===== */
    function openExportPanel() {
      const overlay = document.getElementById("exportOverlay");
      const area = document.getElementById("exportArea");
      const logs = getLogs();
      area.value = JSON.stringify(logs, null, 2);
      overlay.style.display = "flex";
    }

    function closeExportPanel() {
      const overlay = document.getElementById("exportOverlay");
      overlay.style.display = "none";
    }

    function copyExport() {
      const area = document.getElementById("exportArea");
      area.select();
      document.execCommand("copy");
      alert("å·²è¤‡è£½ï¼Œè²¼åˆ°é›²ç«¯è¨˜äº‹æˆ–å‚³çµ¦è‡ªå·±å°±ç®—ã€é›²ç«¯å‚™ä»½ã€äº†ï¼");
    }

    function importFromText() {
      const area = document.getElementById("exportArea");
      const text = area.value.trim();
      if (!text) {
        alert("è«‹å…ˆåœ¨ä¸Šæ–¹è²¼ä¸ŠåŒ¯å‡ºå…§å®¹ï¼");
        return;
      }
      try {
        const data = JSON.parse(text);
        if (!Array.isArray(data)) throw new Error("æ ¼å¼éŒ¯èª¤");
        saveLogs(data);
        alert("åŒ¯å…¥æˆåŠŸï¼Œå·²è¦†è“‹ç›®å‰è³‡æ–™ã€‚");
        render();
      } catch (e) {
        alert("åŒ¯å…¥å¤±æ•—ï¼šæ ¼å¼ä¸æ˜¯æœ‰æ•ˆçš„ JSONã€‚");
      }
    }

    function clearAll() {
      if (!confirm("ç¢ºå®šè¦æ¸…é™¤å…¨éƒ¨ç´€éŒ„å—ï¼Ÿé€™å€‹å‹•ä½œç„¡æ³•å¾©åŸã€‚")) return;
      saveLogs([]);
      render();
    }

    /* ===== Profile / BMI ===== */
    function openProfile() {
      const profile = getProfile();
      document.getElementById("profileHeight").value =
        profile.height != null ? profile.height : "";

      const genderRadios = document.querySelectorAll(
        'input[name="profileGender"]'
      );
      genderRadios.forEach((r) => {
        r.checked = r.value === profile.gender;
      });

      updateProfileBMIText();
      document.getElementById("profileOverlay").style.display = "flex";
    }

    function closeProfile() {
      document.getElementById("profileOverlay").style.display = "none";
    }

    function computeBMI(weightKg, heightCm) {
      if (!weightKg || !heightCm || heightCm <= 0) return null;
      const hM = heightCm / 100;
      return weightKg / (hM * hM);
    }

    function updateProfileBMIText() {
      const profile = getProfile();
      const bmiDiv = document.getElementById("profileBMI");
      const logs = getLogs();
      const pointer = document.getElementById("bmiPointer");

      if (!pointer) return;

      pointer.style.display = "none";

      if (!profile.height || !profile.gender) {
        bmiDiv.textContent =
          "è«‹å…ˆå¡«å¯«èº«é«˜èˆ‡æ€§åˆ¥ï¼Œå„²å­˜å¾Œæœƒä½¿ç”¨æœ€æ–°é«”é‡è¨ˆç®— BMIã€‚";
        return;
      }

      if (!logs.length) {
        bmiDiv.textContent = "ç›®å‰å°šç„¡é«”é‡ç´€éŒ„ï¼Œç„¡æ³•è¨ˆç®— BMIã€‚";
        return;
      }

      const sorted = logs.slice().sort((a, b) => b.date.localeCompare(a.date));
      const last = sorted[0];
      const weight = parseFloat(last.weight);
      const bmi = computeBMI(weight, parseFloat(profile.height));

      if (!bmi) {
        bmiDiv.textContent = "è³‡æ–™ä¸è¶³ï¼Œç„¡æ³•è¨ˆç®— BMIã€‚";
        return;
      }

      const genderText = profile.gender === "male" ? "ç”·" : "å¥³";
      bmiDiv.textContent = `æ€§åˆ¥ï¼š${genderText}ï½œèº«é«˜ï¼š${
        profile.height
      } cm\nä¾ç…§æœ€æ–°é«”é‡ ${weight} kgï¼ŒBMI ç´„ç‚º ${bmi.toFixed(1)}`;

      const min = 15;
      const max = 40;
      let ratio = (bmi - min) / (max - min);
      ratio = Math.max(0, Math.min(1, ratio));

      pointer.style.left = ratio * 100 + "%";
      pointer.style.display = "block";
    }

    function saveProfileData() {
      const heightVal = parseFloat(
        document.getElementById("profileHeight").value
      );
      const genderInput = document.querySelector(
        'input[name="profileGender"]:checked'
      );

      if (!heightVal || isNaN(heightVal) || heightVal <= 0) {
        alert("è«‹è¼¸å…¥æ­£ç¢ºçš„èº«é«˜ï¼ˆcmï¼‰");
        return;
      }
      if (!genderInput) {
        alert("è«‹é¸æ“‡æ€§åˆ¥ï¼ˆç”· / å¥³ï¼‰");
        return;
      }

      const profile = {
        height: heightVal,
        gender: genderInput.value,
      };

      saveProfile(profile);
      updateProfileBMIText();
      alert("å·²å„²å­˜å€‹äººè³‡æ–™èˆ‡ BMI è¨­å®š");
      closeProfile();
    }

    function render() {
      renderRecords();
      renderChart();
      showLatest();
      showWeeklyStats();
    }
  </script>
</body>
</html>