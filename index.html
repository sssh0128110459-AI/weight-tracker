<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>Weight Record</title>

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="theme-color" content="#f7f4ec" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    /* ========= å…¨åŸŸé¡è‰²è®Šæ•¸ï¼ˆç±³è‰²é è¨­ï¼‰ ========= */
    :root {
      --bg-color: #f7f4ec;
      --text-main: #3b3025;
      --text-sub: #7a6951;
      --card-bg: #ffffff;
      --card-shadow: 0 4px 12px rgba(0, 0, 0, 0.06);
      --border-subtle: #d8d0c3;
      --input-bg: #faf7f1;
      --accent: #f0c96a;
      --accent-dark: #e4b34d;
      --danger: #e56565;
      --muted: #8a7b64;
      --chart-axis: #95856d;
      --chart-grid: #e1d7c8;

      --chart-weight: #4b7bff;
      --chart-fat: #f2b933;
      --chart-muscle: #ff5d5d;
      --chart-target: #9b9b9b;

      --tooltip-bg: rgba(69, 60, 44, 0.9);
      --tooltip-text: #ffffff;
    }

    /* ========= æ·±è‰²ä¸»é¡Œ ========= */
    body.dark-mode {
      --bg-color: #101010;
      --text-main: #f7f9ff;
      --text-sub: #c2cadb;
      --card-bg: #181818;
      --card-shadow: 0 4px 18px rgba(0, 0, 0, 0.7);
      --border-subtle: #3a3a3a;
      --input-bg: #232323;
      --accent: #ffcf5a;
      --accent-dark: #e3b447;
      --danger: #ff6b81;
      --muted: #a6b0c0;
      --chart-axis: #d0d6e0;
      --chart-grid: #303030;

      --chart-weight: #5ba0ff;
      --chart-fat: #ffd85f;
      --chart-muscle: #ff7f9a;
      --chart-target: #aaaaaa;

      --tooltip-bg: rgba(14, 14, 14, 0.93);
      --tooltip-text: #f7f9ff;
    }

    /* ========= å†°å³¶è‹”åŸ ========= */
    body.theme-iceland {
      --bg-color: #08130c;
      --text-main: #d6ffe5; /* æ¨™é¡Œ / ä¸»å…§å®¹äº®ç¶  */
      --text-sub: #a5f0c9;
      --card-bg: #0f2216;
      --card-shadow: 0 4px 18px rgba(0, 0, 0, 0.85);
      --border-subtle: #214530;
      --input-bg: #0a1b12;
      --accent: #6ee6ae;
      --accent-dark: #35b275;
      --danger: #ff9a9a;
      --muted: #8ed8b5;
      --chart-axis: #b9f3cf;
      --chart-grid: #163423;

      --chart-weight: #72ffbd;
      --chart-fat: #ffe97a;
      --chart-muscle: #ff8a6a;
      --chart-target: #96a69a;

      --tooltip-bg: rgba(7, 34, 23, 0.95);
      --tooltip-text: #eafff4;
    }

    /* ========= æ«»èŠ± ========= */
    body.theme-sakura {
      --bg-color: #ffeef7;
      --text-main: #5c3a3a;
      --text-sub: #a66574;
      --card-bg: #ffffff;
      --card-shadow: 0 4px 16px rgba(180, 120, 140, 0.25);
      --border-subtle: #f1c5d7;
      --input-bg: #fff7fb;
      --accent: #f78eb4;
      --accent-dark: #e06c96;
      --danger: #e35a73;
      --muted: #966573;
      --chart-axis: #b37a8c;
      --chart-grid: #f0cedf;

      --chart-weight: #ff7aa2;
      --chart-fat: #ffc76a;
      --chart-muscle: #ff5b6c;
      --chart-target: #b8a3b0;

      --tooltip-bg: rgba(102, 67, 84, 0.93);
      --tooltip-text: #fff6fb;
    }

    /* ========= éƒ½å¸‚éœ“è™¹ ========= */
    body.theme-neon {
      --bg-color: #040815;
      --text-main: #e9f4ff;
      --text-sub: #9ab7dd;
      --card-bg: #050c18;
      --card-shadow: 0 4px 20px rgba(0, 0, 0, 0.9);
      --border-subtle: #20395b;
      --input-bg: #071425;
      --accent: #21b3ff;
      --accent-dark: #0f8edb;
      --danger: #ff6f8c;
      --muted: #89a6cc;
      --chart-axis: #d1e4ff;
      --chart-grid: #243554;

      --chart-weight: #3cc7ff;
      --chart-fat: #ffd95c;
      --chart-muscle: #ff6fb1;
      --chart-target: #a1aec2;

      --tooltip-bg: rgba(7, 24, 48, 0.96);
      --tooltip-text: #e9f4ff;
    }

    /* ========= æ„›é¦¬ä»•æ©˜ ========= */
    body.theme-hermes {
      --bg-color: #fff6ee;
      --text-main: #4c2814;
      --text-sub: #9b6543;
      --card-bg: #ffffff;
      --card-shadow: 0 4px 16px rgba(190, 124, 63, 0.22);
      --border-subtle: #f0d0b2;
      --input-bg: #fff3e4;
      --accent: #ff8c3a;       /* æ„›é¦¬ä»•æ©˜èª¿ */
      --accent-dark: #e56f1b;
      --danger: #e85b5b;
      --muted: #9b6a47;
      --chart-axis: #a36b43;
      --chart-grid: #f3d6bd;

      --chart-weight: #ff8c3a;
      --chart-fat: #ffcf5e;
      --chart-muscle: #ff6d6d;
      --chart-target: #c99a7a;

      --tooltip-bg: rgba(103, 54, 24, 0.94);
      --tooltip-text: #fff7f0;
    }

    /* ========= å…¨åŸŸç‰ˆé¢ ========= */
    body {
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI",
        Arial, sans-serif;
      margin: 0;
      background: var(--bg-color);
      color: var(--text-main);
      overflow-x: hidden;
    }

    #main {
      opacity: 0;
      transition: opacity 1s ease;
      max-width: 520px;
      margin: auto;
      padding: 16px 16px 24px;
    }

    .top-bar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin: 4px 0 14px;
    }

    h1 {
      font-size: 24px;
      font-weight: 700;
      margin: 0;
    }

    .top-right {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .icon-btn {
      width: 34px;
      height: 34px;
      border-radius: 999px;
      border: 1px solid var(--border-subtle);
      background: var(--card-bg);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      cursor: pointer;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
      padding: 0;
      color: var(--text-main);
    }

    .card {
      background: var(--card-bg);
      border-radius: 18px;
      box-shadow: var(--card-shadow);
      padding: 16px 16px;
      margin-bottom: 16px;
      border: 1px solid rgba(0, 0, 0, 0.03);
    }

    .input-area {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    input {
      padding: 10px 12px;
      font-size: 16px;
      border-radius: 12px;
      border: 1px solid var(--border-subtle);
      background: var(--input-bg);
      outline: none;
      color: var(--text-main);
      box-sizing: border-box;
    }

    input::placeholder {
      color: var(--muted);
    }

    input:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(248, 206, 126, 0.3);
    }

    button {
      padding: 10px 12px;
      font-size: 16px;
      font-weight: 600;
      border-radius: 14px;
      border: none;
      background: var(--accent);
      color: #111111;
      cursor: pointer;
      transition: 0.15s;
    }

    button:active {
      transform: scale(0.97);
      background: var(--accent-dark);
    }

    .btn-secondary {
      background: var(--card-bg);
      color: var(--text-sub);
      border: 1px solid var(--border-subtle);
    }
    .btn-secondary:active {
      background: var(--input-bg);
    }

    .btn-danger-ghost {
      background: var(--card-bg);
      color: var(--danger);
      border: 1px solid rgba(229, 101, 101, 0.7);
    }

    .btn-row {
      display: flex;
      gap: 8px;
      margin-top: 8px;
      flex-wrap: wrap;
    }

    #latest {
      font-weight: 700;
      font-size: 19px;
      white-space: nowrap;
      transform-origin: left;
      display: inline-block;
      max-width: 100%;
    }
    #latest.auto-scale {
      transform: scale(var(--scale));
    }

    #weeklyStats,
    #targetInfo {
      font-size: 13px;
      margin-top: 6px;
      color: var(--text-sub);
      line-height: 1.5;
      white-space: pre-line;
    }

    #chartWrapper {
      border-radius: 18px;
      padding: 10px;
      background: var(--card-bg);
      box-shadow: var(--card-shadow);
      position: relative;
    }

    .metric-tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 8px;
      flex-wrap: wrap;
    }

    .metric-tab {
      flex: 0 0 auto;
      padding: 6px 14px;
      font-size: 13px;
      border-radius: 999px;
      border: 1px solid var(--border-subtle);
      background: var(--card-bg);
      color: var(--text-sub);
      cursor: pointer;
      line-height: 1.2;
    }
    .metric-tab.active {
      background: var(--accent);
      color: #111111;
      border-color: var(--accent-dark);
    }

    .chart-nav {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      margin-bottom: 6px;
      font-size: 12px;
      color: var(--text-sub);
    }

    .chart-nav-btn {
      padding: 4px 10px;
      font-size: 12px;
      border-radius: 999px;
      border: 1px solid var(--border-subtle);
      background: var(--card-bg);
      color: var(--text-sub);
      cursor: pointer;
    }

    #chartScroll {
      width: 100%;
      overflow-x: auto;
      overflow-y: hidden;
      padding-bottom: 4px;
    }
    #chartScroll::-webkit-scrollbar {
      height: 6px;
    }
    #chartScroll::-webkit-scrollbar-thumb {
      background: #d8d2c8;
      border-radius: 10px;
    }
    body.dark-mode #chartScroll::-webkit-scrollbar-thumb,
    body.theme-iceland #chartScroll::-webkit-scrollbar-thumb,
    body.theme-neon #chartScroll::-webkit-scrollbar-thumb {
      background: var(--border-subtle);
    }
    body.theme-sakura #chartScroll::-webkit-scrollbar-thumb,
    body.theme-hermes #chartScroll::-webkit-scrollbar-thumb {
      background: #f0c6d3;
    }

    #weightChart {
      display: block;
    }

    /* è‡ªè¨‚ legendï¼ˆå¯¦å¿ƒæç¤ºæ ¼ï¼‰ */
    .metric-legend {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-bottom: 4px;
      font-size: 12px;
    }

    .legend-item {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 3px 8px;
      border-radius: 999px;
      font-size: 11px;
      color: var(--text-main);
      background: var(--input-bg);
    }

    .legend-color-box {
      width: 18px;
      height: 10px;
      border-radius: 999px;
      background: #ccc;
    }

    .legend-weight .legend-color-box {
      background: var(--chart-weight);
    }
    .legend-fat .legend-color-box {
      background: var(--chart-fat);
    }
    .legend-muscle .legend-color-box {
      background: var(--chart-muscle);
    }
    .legend-target .legend-color-box {
      background: var(--chart-target);
    }

    #records {
      margin-top: 6px;
    }

    .record {
      background: var(--card-bg);
      border-radius: 14px;
      padding: 8px 10px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.06);
      margin-bottom: 6px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      border: 1px solid rgba(0, 0, 0, 0.02);
    }

    .record-text {
      font-size: 13px;
      font-weight: 500;
      color: var(--text-main);
      white-space: nowrap;
    }

    .record-actions {
      display: flex;
      gap: 4px;
      flex-shrink: 0;
    }

    .edit-btn,
    .delete-btn {
      padding: 4px 8px;
      font-size: 11px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      min-width: 44px;
    }
    .edit-btn {
      background: var(--accent);
      color: #111111;
    }
    .delete-btn {
      background: var(--danger);
      color: #ffffff;
    }

    .month-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .month-title {
      font-size: 15px;
      font-weight: 600;
      color: var(--text-main);
    }

    .month-toggle {
      font-size: 12px;
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid var(--border-subtle);
      background: var(--card-bg);
      color: var(--text-sub);
      cursor: pointer;
    }

    /* ========= Modal åŸºç¤ ========= */
    #modalOverlay,
    #profileOverlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.45);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 10000;
      backdrop-filter: blur(3px);
    }

    #modal,
    #profileModal {
      width: 90%;
      max-width: 360px;
      background: var(--card-bg);
      border-radius: 20px;
      padding: 18px 18px 16px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.35);
      border: 1px solid rgba(0, 0, 0, 0.08);
    }

    #modal h2,
    #profileModal h2 {
      margin: 0 0 10px;
      text-align: center;
      font-size: 18px;
    }

    .modal-row {
      margin-bottom: 10px;
      display: flex;
      flex-direction: column;
      gap: 4px;
      font-size: 14px;
      color: var(--text-main);
    }

    .modal-btns {
      display: flex;
      gap: 10px;
      margin-top: 10px;
    }

    .btn-cancel {
      flex: 1;
      background: var(--card-bg);
      color: var(--text-sub);
      border-radius: 12px;
      padding: 10px;
      border: 1px solid var(--border-subtle);
    }
    .btn-save {
      flex: 1;
      background: var(--accent);
      color: #111111;
      border-radius: 12px;
      padding: 10px;
      border: none;
    }

    .gender-row {
      display: flex;
      gap: 12px;
      font-size: 14px;
      align-items: center;
    }

    .gender-row label {
      display: flex;
      align-items: center;
      gap: 4px;
      cursor: pointer;
    }

    #profileBMI {
      margin-top: 4px;
      font-size: 13px;
      color: var(--text-sub);
      line-height: 1.5;
      white-space: pre-line;
    }

    .bmi-bar-container {
      margin-top: 6px;
    }
    .bmi-bar-wrapper {
      position: relative;
      width: 100%;
      height: 26px;
    }
    .bmi-bar {
      position: absolute;
      left: 0;
      right: 0;
      top: 5px;
      height: 12px;
      border-radius: 999px;
      overflow: hidden;
      display: flex;
      border: 1px solid rgba(0, 0, 0, 0.08);
    }
    .bmi-seg { flex: 1; }
    .bmi-low { background: #6ca8ff; }
    .bmi-mid { background: #fdfdfd; }
    .bmi-high { background: #ff7b7b; }

    .bmi-pointer {
      position: absolute;
      bottom: 0;
      width: 0;
      height: 0;
      border-left: 6px solid transparent;
      border-right: 6px solid transparent;
      border-top: 8px solid #3b3025;
      transform: translateX(-50%);
      display: none;
    }

    body.dark-mode .bmi-pointer,
    body.theme-iceland .bmi-pointer,
    body.theme-neon .bmi-pointer {
      border-top-color: #f5f5f5;
    }

    /* ========= è¨­å®šå´æ¬„ ========= */
    #settingsOverlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.32);
      display: none;
      justify-content: flex-end;
      align-items: stretch;
      z-index: 10002;
      backdrop-filter: blur(2px);
    }

    #settingsPanel {
      width: 86%;
      max-width: 380px;
      background: var(--card-bg);
      border-left: 1px solid var(--border-subtle);
      box-shadow: -4px 0 18px rgba(0, 0, 0, 0.25);
      padding: 16px 14px 20px;
      display: flex;
      flex-direction: column;
      box-sizing: border-box;
      max-height: 100vh;
      overflow-y: auto;
    }

    .settings-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
      font-size: 15px;
      font-weight: 600;
    }

    .settings-close {
      border: none;
      background: transparent;
      font-size: 18px;
      cursor: pointer;
      color: var(--text-sub);
      padding: 4px;
    }

    .settings-section {
      margin-top: 10px;
      font-size: 13px;
    }

    .settings-section-title {
      font-weight: 600;
      margin-bottom: 6px;
      color: var(--text-main);
    }

    .theme-choice-row {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
    }

    .settings-toggle {
      padding: 7px 14px;
      font-size: 13px;
      border-radius: 999px;
      border: 1px solid var(--border-subtle);
      background: var(--card-bg);
      color: var(--text-sub);
      cursor: pointer;
      min-width: 70px;
      text-align: center;
    }
    .settings-toggle.active {
      background: var(--accent);
      color: #111111;
      border-color: var(--accent-dark);
    }

    .settings-row {
      display: flex;
      gap: 6px;
      align-items: center;
    }

    .settings-row input {
      flex: 1;
    }

    .settings-hint {
      font-size: 11px;
      color: var(--text-sub);
      margin-top: 4px;
    }

    #exportArea {
      width: 100%;
      min-height: 80px;
      font-size: 11px;
      padding: 6px 8px;
      border-radius: 10px;
      border: 1px solid var(--border-subtle);
      background: var(--input-bg);
      color: var(--text-main);
      resize: vertical;
      box-sizing: border-box;
    }

    .export-tip {
      font-size: 10px;
      color: var(--text-sub);
      margin-top: 6px;
      line-height: 1.4;
    }

    .settings-section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .section-toggle-btn {
      border-radius: 999px;
      border: 1px solid var(--border-subtle);
      padding: 4px 10px;
      font-size: 11px;
      background: var(--card-bg);
      color: var(--text-sub);
      cursor: pointer;
    }

    /* ========= é–‹å ´å‹•ç•« ========= */
    #splash {
      position: fixed;
      inset: 0;
      background: #f2e7c7;
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 999999;
      opacity: 1;
      transition: opacity 0.8s ease;
    }

    #splash-logo {
      font-size: 34px;
      font-weight: 700;
      color: #3b3025;
      opacity: 0;
      transform: scale(0.85) translateY(24px);
      filter: blur(8px);
      animation: splashFancy 1.2s ease forwards;
    }

    @keyframes splashFancy {
      0% {
        opacity: 0;
        transform: scale(0.85) translateY(24px);
        filter: blur(8px);
      }
      45% {
        opacity: 1;
        transform: scale(1.04) translateY(-4px);
        filter: blur(0px);
      }
      80% {
        opacity: 1;
        transform: scale(1) translateY(0);
        filter: blur(0px);
      }
      100% {
        opacity: 1;
        transform: scale(1) translateY(0);
        filter: blur(0px);
      }
    }
  </style>
</head>

<body>
  <!-- é–‹å ´å‹•ç•« -->
  <div id="splash">
    <div id="splash-logo">Weight Record</div>
  </div>

  <div id="main">
    <div class="top-bar">
      <h1>Weight Record</h1>
      <div class="top-right">
        <button class="icon-btn" id="profileBtn" title="å€‹äººè³‡æ–™">ğŸ‘¤</button>
        <button class="icon-btn" id="settingsBtn" title="è¨­å®š">âš™ï¸</button>
      </div>
    </div>

    <!-- è¼¸å…¥å€ -->
    <div class="card">
      <div class="input-area">
        <input id="dateInput" type="date" />
        <input id="weightInput" type="number" step="0.1" placeholder="é«”é‡ (kg)" />
        <input id="fatInput" type="number" step="0.1" placeholder="é«”è„‚ (%)ï¼ˆå¯é¸å¡«ï¼‰" />
        <input id="muscleInput" type="number" step="0.1" placeholder="éª¨éª¼è‚Œ (%)ï¼ˆå¯é¸å¡«ï¼‰" />
        <button onclick="addRecord()">æ–°å¢ç´€éŒ„</button>
      </div>
    </div>

    <!-- æœ€æ–°ç´€éŒ„ / é€±è®ŠåŒ– / ç›®æ¨™é«”é‡ -->
    <div class="card">
      <div id="latest"></div>
      <div id="weeklyStats"></div>
      <div id="targetInfo"></div>
    </div>

    <!-- åœ–è¡¨ -->
    <div id="chartWrapper" class="card">
      <div class="metric-tabs">
        <button class="metric-tab active" id="tabAll" onclick="setMetricMode('all')">å…¨éƒ¨</button>
        <button class="metric-tab" id="tabWeight" onclick="setMetricMode('weight')">é«”é‡</button>
        <button class="metric-tab" id="tabFat" onclick="setMetricMode('fat')">é«”è„‚</button>
        <button class="metric-tab" id="tabMuscle" onclick="setMetricMode('muscle')">éª¨éª¼è‚Œ</button>
      </div>
      <div class="chart-nav">
        <button class="chart-nav-btn" onclick="shiftChartWindow(-1)">â†</button>
        <span id="chartRangeLabel"></span>
        <button class="chart-nav-btn" onclick="shiftChartWindow(1)">â†’</button>
      </div>
      <div class="metric-legend">
        <div class="legend-item legend-weight">
          <span class="legend-color-box"></span><span>é«”é‡ (kg)</span>
        </div>
        <div class="legend-item legend-fat">
          <span class="legend-color-box"></span><span>é«”è„‚ (%)</span>
        </div>
        <div class="legend-item legend-muscle">
          <span class="legend-color-box"></span><span>éª¨éª¼è‚Œ (%)</span>
        </div>
        <div class="legend-item legend-target">
          <span class="legend-color-box"></span><span>ç›®æ¨™é«”é‡</span>
        </div>
      </div>
      <div id="chartScroll">
        <canvas id="weightChart"></canvas>
      </div>
    </div>

    <!-- æ­·å²ç´€éŒ„ -->
    <div id="records"></div>
  </div>

  <!-- ç·¨è¼¯ç´€éŒ„ Modal -->
  <div id="modalOverlay">
    <div id="modal">
      <h2>ç·¨è¼¯ç´€éŒ„</h2>

      <div class="modal-row">
        <label>æ—¥æœŸï¼š</label>
        <input id="editDate" type="date" />
      </div>
      <div class="modal-row">
        <label>é«”é‡ (kg)ï¼š</label>
        <input id="editWeight" type="number" step="0.1" />
      </div>
      <div class="modal-row">
        <label>é«”è„‚ (%)ï¼š</label>
        <input id="editFat" type="number" step="0.1" />
      </div>
      <div class="modal-row">
        <label>éª¨éª¼è‚Œ (%)ï¼š</label>
        <input id="editMuscle" type="number" step="0.1" />
      </div>

      <div class="modal-btns">
        <button class="btn-cancel" onclick="closeModal()">å–æ¶ˆ</button>
        <button class="btn-save" onclick="saveEdit()">å„²å­˜</button>
      </div>
    </div>
  </div>

  <!-- å€‹äººè³‡æ–™ / BMI Modal -->
  <div id="profileOverlay">
    <div id="profileModal">
      <h2>å€‹äººè³‡æ–™</h2>

      <div class="modal-row">
        <label>èº«é«˜ï¼ˆcmï¼‰ï¼š</label>
        <input id="profileHeight" type="number" step="0.1" placeholder="ä¾‹å¦‚ 170" />
      </div>

      <div class="modal-row">
        <label>æ€§åˆ¥ï¼š</label>
        <div class="gender-row">
          <label><input type="radio" name="profileGender" value="male" /> ç”·</label>
          <label><input type="radio" name="profileGender" value="female" /> å¥³</label>
        </div>
      </div>

      <div class="modal-row bmi-bar-container">
        <label>BMI æŒ‡æ¨™ï¼š</label>
        <div class="bmi-bar-wrapper">
          <div class="bmi-bar">
            <div class="bmi-seg bmi-low"></div>
            <div class="bmi-seg bmi-mid"></div>
            <div class="bmi-seg bmi-high"></div>
          </div>
          <div id="bmiPointer" class="bmi-pointer"></div>
        </div>
        <div id="profileBMI"></div>
      </div>

      <div class="modal-btns">
        <button class="btn-cancel" onclick="closeProfile()">å–æ¶ˆ</button>
        <button class="btn-save" onclick="saveProfileData()">å„²å­˜</button>
      </div>
    </div>
  </div>

  <!-- è¨­å®šå´æ¬„ -->
  <div id="settingsOverlay" onclick="if(event.target === this) closeSettings();">
    <div id="settingsPanel">
      <div class="settings-header">
        <span>è¨­å®š</span>
        <button class="settings-close" onclick="closeSettings()">âœ•</button>
      </div>

      <!-- å¤–è§€ï¼šä¸»é¡Œé¸æ“‡ -->
      <div class="settings-section">
        <div class="settings-section-title">å¤–è§€</div>
        <div class="theme-choice-row">
          <button id="themeLightBtn" class="settings-toggle" type="button" onclick="applyTheme('light')">
            ç±³è‰²
          </button>
          <button id="themeDarkBtn" class="settings-toggle" type="button" onclick="applyTheme('dark')">
            æ·±è‰²
          </button>
          <button id="themeIcelandBtn" class="settings-toggle" type="button" onclick="applyTheme('iceland')">
            å†°å³¶è‹”åŸ
          </button>
          <button id="themeSakuraBtn" class="settings-toggle" type="button" onclick="applyTheme('sakura')">
            æ«»èŠ±
          </button>
          <button id="themeNeonBtn" class="settings-toggle" type="button" onclick="applyTheme('neon')">
            éƒ½å¸‚éœ“è™¹
          </button>
          <button id="themeHermesBtn" class="settings-toggle" type="button" onclick="applyTheme('hermes')">
            æ„›é¦¬ä»•æ©˜
          </button>
        </div>
      </div>

      <!-- ç›®æ¨™é«”é‡ -->
      <div class="settings-section">
        <div class="settings-section-title">ç›®æ¨™é«”é‡</div>
        <div class="settings-row">
          <input id="targetInput" type="number" step="0.1" placeholder="ä¾‹å¦‚ 70" />
          <button class="btn-secondary" onclick="saveTargetFromSettings()">å„²å­˜</button>
        </div>
        <div id="targetHint" class="settings-hint"></div>
      </div>

      <!-- è³‡æ–™å‚™ä»½ï¼ˆå¯å±•é–‹å€ï¼‰ -->
      <div class="settings-section">
        <div class="settings-section-header">
          <div class="settings-section-title">è³‡æ–™å‚™ä»½</div>
          <button id="backupToggleBtn" class="section-toggle-btn" type="button" onclick="toggleBackupSection()">
            å±•é–‹
          </button>
        </div>
        <div id="backupBody" style="display:none; margin-top:6px;">
          <textarea id="exportArea"></textarea>
          <div class="btn-row" style="margin-top: 8px;">
            <button class="btn-secondary" onclick="copyExport()">è¤‡è£½åŒ¯å‡ºå…§å®¹</button>
            <button class="btn-secondary" onclick="importFromText()">åŒ¯å…¥è²¼ä¸Šçš„è³‡æ–™</button>
          </div>
          <div class="btn-row" style="margin-top: 4px;">
            <button class="btn-danger-ghost" onclick="clearAll()">æ¸…é™¤å…¨éƒ¨ç´€éŒ„</button>
          </div>
          <div class="export-tip">
            åŒ¯å‡ºï¼šæŒ‰ã€Œè¤‡è£½åŒ¯å‡ºå…§å®¹ã€ï¼Œè²¼åˆ°é›²ç«¯è¨˜äº‹ / Line è‡ªå·±ã€‚<br />
            åŒ¯å…¥ï¼šè²¼ä¸Š JSON å¾ŒæŒ‰ã€ŒåŒ¯å…¥è²¼ä¸Šçš„è³‡æ–™ã€å³å¯ã€‚
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const STORAGE_KEY = "weight_logs";
    const THEME_KEY = "weight_theme"; // light | dark | iceland | sakura | neon | hermes
    const PROFILE_KEY = "weight_profile";
    const TARGET_KEY = "weight_target";

    let editIndex = null;
    let chart = null;
    let metricMode = "all"; // all | weight | fat | muscle
    let chartWindowStart = null;
    let touchStartX = null;

    function getLogs() {
      return JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]");
    }
    function saveLogs(logs) {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(logs));
    }

    function getProfile() {
      return JSON.parse(localStorage.getItem(PROFILE_KEY) || "{}");
    }
    function saveProfile(profile) {
      localStorage.setItem(PROFILE_KEY, JSON.stringify(profile));
    }

    function getTarget() {
      const v = localStorage.getItem(TARGET_KEY);
      if (!v) return null;
      const n = parseFloat(v);
      return isNaN(n) ? null : n;
    }
    function setTarget(val) {
      if (val == null || isNaN(val)) localStorage.removeItem(TARGET_KEY);
      else localStorage.setItem(TARGET_KEY, String(val));
    }

    /* ========= ä¸»é¡Œåˆ‡æ› ========= */
    function applyTheme(mode) {
      const body = document.body;
      body.className = ""; // æ¸…é™¤å…¨éƒ¨
      if (mode === "dark") body.classList.add("dark-mode");
      else if (mode === "iceland") body.classList.add("theme-iceland");
      else if (mode === "sakura") body.classList.add("theme-sakura");
      else if (mode === "neon") body.classList.add("theme-neon");
      else if (mode === "hermes") body.classList.add("theme-hermes");

      localStorage.setItem(THEME_KEY, mode);
      updateThemeButtons(mode);
      // ä¸»é¡Œè®Šæ›´å¾Œé‡æ–°ç•«åœ–ï¼Œæ›´æ–°è»¸ç·š/legendé¡è‰²
      renderChart();
    }

    function initTheme() {
      const saved = localStorage.getItem(THEME_KEY) || "light";
      applyTheme(saved);
    }

    function updateThemeButtons(mode) {
      const current = mode || localStorage.getItem(THEME_KEY) || "light";
      const map = {
        light: document.getElementById("themeLightBtn"),
        dark: document.getElementById("themeDarkBtn"),
        iceland: document.getElementById("themeIcelandBtn"),
        sakura: document.getElementById("themeSakuraBtn"),
        neon: document.getElementById("themeNeonBtn"),
        hermes: document.getElementById("themeHermesBtn"),
      };
      Object.keys(map).forEach((key) => {
        const btn = map[key];
        if (!btn) return;
        btn.classList.toggle("active", key === current);
      });
    }

    window.addEventListener("load", () => {
      initTheme();
      setDefaultDate();

      const splash = document.getElementById("splash");
      const main = document.getElementById("main");

      setTimeout(() => {
        main.style.opacity = 1;
        splash.style.opacity = 0;
        setTimeout(() => {
          splash.style.display = "none";
        }, 900);
      }, 1100);

      document.getElementById("profileBtn").addEventListener("click", openProfile);
      document.getElementById("settingsBtn").addEventListener("click", openSettings);

      const wrapper = document.getElementById("chartWrapper");
      wrapper.addEventListener("touchstart", (e) => {
        if (!e.touches.length) return;
        touchStartX = e.touches[0].clientX;
      });
      wrapper.addEventListener("touchend", (e) => {
        if (touchStartX == null || !e.changedTouches.length) return;
        const dx = e.changedTouches[0].clientX - touchStartX;
        if (dx > 50) shiftChartWindow(-1);
        else if (dx < -50) shiftChartWindow(1);
        touchStartX = null;
      });

      render();
    });

    /* ========= æ—¥æœŸ & æ–°å¢ ========= */
    function setDefaultDate() {
      const d = document.getElementById("dateInput");
      if (!d.value) d.value = new Date().toISOString().slice(0, 10);
    }

    function addRecord() {
      const dateInput = document.getElementById("dateInput");
      const weightInput = document.getElementById("weightInput");
      const fatInput = document.getElementById("fatInput");
      const muscleInput = document.getElementById("muscleInput");

      const date = dateInput.value || new Date().toISOString().slice(0, 10);
      const weight = weightInput.value;
      const fat = fatInput.value;
      const muscle = muscleInput.value;

      if (!weight) {
        alert("è«‹è¼¸å…¥é«”é‡ï¼");
        return;
      }

      const logs = getLogs();
      logs.push({ date, weight, fat, muscle });
      saveLogs(logs);

      weightInput.value = "";
      fatInput.value = "";
      muscleInput.value = "";
      render();
    }

    /* ========= æœ€æ–°ç´€éŒ„ & çµ±è¨ˆ ========= */
    function autoScaleLatest() {
      const el = document.getElementById("latest");
      if (!el.textContent) return;
      el.style.setProperty("--scale", 1);
      el.classList.add("auto-scale");
      const parentWidth = el.parentElement.clientWidth;
      const scale = parentWidth / el.scrollWidth;
      el.style.setProperty("--scale", Math.min(scale, 1));
    }

    function showLatest() {
      const logs = getLogs();
      const latestDiv = document.getElementById("latest");
      if (!logs.length) {
        latestDiv.textContent = "å°šç„¡ç´€éŒ„";
        autoScaleLatest();
        return;
      }
      const sorted = logs.slice().sort((a, b) => b.date.localeCompare(a.date));
      const last = sorted[0];
      let text = `${last.date}ï¼š${last.weight} kg`;
      if (last.fat) text += `ï¼Œé«”è„‚ ${last.fat}%`;
      if (last.muscle) text += `ï¼Œéª¨éª¼è‚Œ ${last.muscle}%`;
      latestDiv.textContent = text;
      autoScaleLatest();
    }

    function showWeeklyStats() {
      const logs = getLogs();
      const box = document.getElementById("weeklyStats");
      if (!logs.length) {
        box.textContent = "";
        return;
      }

      const dates = logs.map((l) => l.date).filter(Boolean).sort();
      const latestDateStr = dates[dates.length - 1];
      const latestDate = new Date(latestDateStr);

      function dayDiff(a, b) {
        return Math.floor((a - b) / (1000 * 60 * 60 * 24));
      }

      const curW = [],
        prevW = [],
        curF = [],
        prevF = [],
        curM = [],
        prevM = [];
      logs.forEach((l) => {
        if (!l.date) return;
        const d = new Date(l.date);
        const diff = dayDiff(latestDate, d);
        const w = parseFloat(l.weight);
        const f = l.fat ? parseFloat(l.fat) : NaN;
        const m = l.muscle ? parseFloat(l.muscle) : NaN;
        if (diff >= 0 && diff <= 6) {
          if (!isNaN(w)) curW.push(w);
          if (!isNaN(f)) curF.push(f);
          if (!isNaN(m)) curM.push(m);
        } else if (diff >= 7 && diff <= 13) {
          if (!isNaN(w)) prevW.push(w);
          if (!isNaN(f)) prevF.push(f);
          if (!isNaN(m)) prevM.push(m);
        }
      });

      function avg(arr) {
        if (!arr.length) return null;
        return arr.reduce((a, b) => a + b, 0) / arr.length;
      }

      const curWA = avg(curW),
        prevWA = avg(prevW);
      const curFA = avg(curF),
        prevFA = avg(prevF);
      const curMA = avg(curM),
        prevMA = avg(prevM);

      let lines = [];
      if (curWA !== null) {
        let line = `æœ€è¿‘ 7 å¤©å¹³å‡é«”é‡ï¼šç´„ ${curWA.toFixed(1)} kg`;
        if (prevWA !== null) {
          const diff = curWA - prevWA;
          const sign = diff > 0 ? "+" : "";
          line += `ï¼ˆè¼ƒå‰ 7 å¤© ${sign}${diff.toFixed(1)} kgï¼‰`;
        }
        lines.push(line);
      }
      if (curFA !== null) {
        let line = `æœ€è¿‘ 7 å¤©å¹³å‡é«”è„‚ï¼šç´„ ${curFA.toFixed(1)} %`;
        if (prevFA !== null) {
          const diff = curFA - prevFA;
          const sign = diff > 0 ? "+" : "";
          line += `ï¼ˆè¼ƒå‰ 7 å¤© ${sign}${diff.toFixed(1)} %ï¼‰`;
        }
        lines.push(line);
      }
      if (curMA !== null) {
        let line = `æœ€è¿‘ 7 å¤©å¹³å‡éª¨éª¼è‚Œï¼šç´„ ${curMA.toFixed(1)} %`;
        if (prevMA !== null) {
          const diff = curMA - prevMA;
          const sign = diff > 0 ? "+" : "";
          line += `ï¼ˆè¼ƒå‰ 7 å¤© ${sign}${diff.toFixed(1)} %ï¼‰`;
        }
        lines.push(line);
      }
      box.textContent = lines.join("\n");
    }

    function showTargetInfo() {
      const info = document.getElementById("targetInfo");
      const target = getTarget();
      if (!info) return;
      if (target == null) {
        info.textContent = "";
        return;
      }

      const logs = getLogs();
      if (!logs.length) {
        info.textContent = `ç›®æ¨™é«”é‡ï¼š${target} kg`;
        return;
      }
      const sorted = logs.slice().sort((a, b) => b.date.localeCompare(a.date));
      const last = sorted[0];
      const w = parseFloat(last.weight);
      if (isNaN(w)) {
        info.textContent = `ç›®æ¨™é«”é‡ï¼š${target} kg`;
        return;
      }

      const diff = w - target;
      let diffText;
      if (Math.abs(diff) < 0.05) diffText = "å·²é”æˆç›®æ¨™ï¼";
      else if (diff > 0) diffText = `è·é›¢ç›®æ¨™é‚„éœ€æ¸›å°‘ ${diff.toFixed(1)} kg`;
      else diffText = `è·é›¢ç›®æ¨™é‚„å·®å¢åŠ  ${Math.abs(diff).toFixed(1)} kg`;

      info.textContent = `ç›®æ¨™é«”é‡ï¼š${target} kgï¼ˆ${diffText}ï¼‰`;
    }

    /* ========= åœ–è¡¨ ========= */
    function renderChart() {
      const logs = getLogs();
      const rangeLabel = document.getElementById("chartRangeLabel");
      if (!logs.length) {
        if (chart) {
          chart.destroy();
          chart = null;
        }
        rangeLabel.textContent = "";
        return;
      }

      const byDate = {};
      logs.forEach((l) => {
        if (!l.date) return;
        if (!byDate[l.date]) byDate[l.date] = { w: [], f: [], m: [] };
        const w = parseFloat(l.weight);
        if (!isNaN(w)) byDate[l.date].w.push(w);
        if (l.fat) {
          const f = parseFloat(l.fat);
          if (!isNaN(f)) byDate[l.date].f.push(f);
        }
        if (l.muscle) {
          const m = parseFloat(l.muscle);
          if (!isNaN(m)) byDate[l.date].m.push(m);
        }
      });

      const allDates = Object.keys(byDate).sort();
      if (!allDates.length) {
        if (chart) {
          chart.destroy();
          chart = null;
        }
        rangeLabel.textContent = "";
        return;
      }

      const windowSize = 7;
      if (chartWindowStart === null)
        chartWindowStart = Math.max(0, allDates.length - windowSize);

      chartWindowStart = Math.max(
        0,
        Math.min(chartWindowStart, Math.max(0, allDates.length - windowSize))
      );
      const end = chartWindowStart + windowSize;
      const dates = allDates.slice(chartWindowStart, end);

      const weights = dates.map(
        (d) => byDate[d].w.reduce((a, b) => a + b, 0) / byDate[d].w.length
      );
      const fats = dates.map((d) =>
        byDate[d].f.length
          ? byDate[d].f.reduce((a, b) => a + b, 0) / byDate[d].f.length
          : null
      );
      const muscles = dates.map((d) =>
        byDate[d].m.length
          ? byDate[d].m.reduce((a, b) => a + b, 0) / byDate[d].m.length
          : null
      );

      if (dates.length)
        rangeLabel.textContent = `${dates[0]} ~ ${dates[dates.length - 1]}`;
      else rangeLabel.textContent = "";

      const canvas = document.getElementById("weightChart");
      canvas.width = Math.max(dates.length * 70, 280);
      canvas.height = 240;
      const ctx = canvas.getContext("2d");
      if (chart) chart.destroy();

      const cs = getComputedStyle(document.body);
      const weightColor = (cs.getPropertyValue("--chart-weight") || "#4b7bff").trim();
      const fatColor = (cs.getPropertyValue("--chart-fat") || "#f2b933").trim();
      const muscleColor = (cs.getPropertyValue("--chart-muscle") || "#ff5d5d").trim();
      const targetColor = (cs.getPropertyValue("--chart-target") || "#9b9b9b").trim();
      const axisColor = (cs.getPropertyValue("--chart-axis") || "#666").trim();
      const gridColor = (cs.getPropertyValue("--chart-grid") || "#ddd").trim();
      const legendColor = (cs.getPropertyValue("--text-main") || "#333").trim();
      const tooltipBg = (cs.getPropertyValue("--tooltip-bg") || "rgba(0,0,0,0.8)").trim();
      const tooltipText = (cs.getPropertyValue("--tooltip-text") || "#fff").trim();

      const datasets = [];
      if (metricMode === "all" || metricMode === "weight") {
        datasets.push({
          label: "é«”é‡ (kg)",
          data: weights,
          borderWidth: 2,
          tension: 0.25,
          pointRadius: 4,
          pointHoverRadius: 5,
          borderColor: weightColor,
          backgroundColor: weightColor, // legend å¯¦å¿ƒ
        });
      }
      if (metricMode === "all" || metricMode === "fat") {
        datasets.push({
          label: "é«”è„‚ (%)",
          data: fats,
          borderWidth: 2,
          tension: 0.25,
          pointRadius: 4,
          pointHoverRadius: 5,
          borderColor: fatColor,
          backgroundColor: fatColor,
        });
      }
      if (metricMode === "all" || metricMode === "muscle") {
        datasets.push({
          label: "éª¨éª¼è‚Œ (%)",
          data: muscles,
          borderWidth: 2,
          tension: 0.25,
          pointRadius: 4,
          pointHoverRadius: 5,
          borderColor: muscleColor,
          backgroundColor: muscleColor,
        });
      }

      const target = getTarget();
      if ((metricMode === "all" || metricMode === "weight") && target != null && dates.length) {
        datasets.push({
          label: "ç›®æ¨™é«”é‡",
          data: dates.map(() => target),
          borderWidth: 1.5,
          borderDash: [6, 4],
          pointRadius: 0,
          borderColor: targetColor,
          backgroundColor: targetColor,
        });
      }

      chart = new Chart(ctx, {
        type: "line",
        data: { labels: dates, datasets },
        options: {
          responsive: false,
          maintainAspectRatio: false,
          spanGaps: true,
          scales: {
            x: {
              ticks: { color: axisColor },
              grid: { color: gridColor },
            },
            y: {
              ticks: { color: axisColor },
              grid: { color: gridColor },
            },
          },
          plugins: {
            legend: {
              display: false, // æˆ‘å€‘è‡ªå·±ç•« legend
              labels: { color: legendColor, boxWidth: 24, padding: 12 },
            },
            tooltip: {
              backgroundColor: tooltipBg,
              titleColor: tooltipText,
              bodyColor: tooltipText,
              cornerRadius: 8,
            },
          },
        },
      });
    }

    function setMetricMode(mode) {
      metricMode = mode;
      const tabs = {
        all: document.getElementById("tabAll"),
        weight: document.getElementById("tabWeight"),
        fat: document.getElementById("tabFat"),
        muscle: document.getElementById("tabMuscle"),
      };
      Object.keys(tabs).forEach((k) => {
        if (!tabs[k]) return;
        tabs[k].classList.toggle("active", k === mode);
      });
      renderChart();
    }

    function shiftChartWindow(direction) {
      const logs = getLogs();
      if (!logs.length) return;
      const dates = [...new Set(logs.map((l) => l.date).filter(Boolean))].sort();
      if (!dates.length) return;

      const windowSize = 7;
      if (chartWindowStart === null)
        chartWindowStart = Math.max(0, dates.length - windowSize);

      chartWindowStart += direction;
      chartWindowStart = Math.max(
        0,
        Math.min(chartWindowStart, Math.max(0, dates.length - windowSize))
      );
      renderChart();
    }

    /* ========= æ­·å²ç´€éŒ„ ========= */
    function renderRecords() {
      const logs = getLogs();
      const box = document.getElementById("records");
      box.innerHTML = "";
      if (!logs.length) {
        const empty = document.createElement("div");
        empty.className = "card";
        empty.textContent = "ç›®å‰å°šç„¡ç´€éŒ„ï¼Œè«‹å…ˆæ–°å¢ä¸€ç­†ã€‚";
        box.appendChild(empty);
        return;
      }

      const sorted = logs.slice().sort((a, b) => b.date.localeCompare(a.date));
      const groups = {};
      sorted.forEach((log) => {
        const dateStr = log.date || "";
        const monthKey = dateStr.length >= 7 ? dateStr.slice(0, 7) : "æœªçŸ¥";
        if (!groups[monthKey]) groups[monthKey] = [];
        groups[monthKey].push(log);
      });

      const monthKeys = Object.keys(groups).sort((a, b) => b.localeCompare(a));
      monthKeys.forEach((monthKey, idx) => {
        const monthLogs = groups[monthKey];
        const monthCard = document.createElement("div");
        monthCard.className = "card";

        const header = document.createElement("div");
        header.className = "month-header";
        const title = document.createElement("div");
        title.className = "month-title";
        if (monthKey === "æœªçŸ¥") title.textContent = "æœªè¨­å®šæ—¥æœŸ";
        else {
          const [y, m] = monthKey.split("-");
          title.textContent = `${y} å¹´ ${m} æœˆ`;
        }

        const toggleBtn = document.createElement("button");
        toggleBtn.className = "month-toggle";
        const body = document.createElement("div");

        if (idx === 0) {
          body.style.display = "block";
          toggleBtn.textContent = "æ”¶åˆ";
        } else {
          body.style.display = "none";
          toggleBtn.textContent = "å±•é–‹";
        }

        toggleBtn.onclick = () => {
          if (body.style.display === "none") {
            body.style.display = "block";
            toggleBtn.textContent = "æ”¶åˆ";
          } else {
            body.style.display = "none";
            toggleBtn.textContent = "å±•é–‹";
          }
        };

        header.appendChild(title);
        header.appendChild(toggleBtn);
        monthCard.appendChild(header);

        monthLogs.forEach((l) => {
          const all = getLogs();
          const idxInAll = all.indexOf(l);

          const div = document.createElement("div");
          div.className = "record";

          const t = document.createElement("div");
          t.className = "record-text";
          let text = `${l.date}ï½œ${l.weight} kg`;
          if (l.fat) text += `ï½œé«”è„‚ ${l.fat}%`;
          if (l.muscle) text += `ï½œéª¨éª¼è‚Œ ${l.muscle}%`;
          t.textContent = text;

          const actions = document.createElement("div");
          actions.className = "record-actions";
          const eBtn = document.createElement("button");
          eBtn.className = "edit-btn";
          eBtn.textContent = "ç·¨è¼¯";
          eBtn.onclick = () => openModal(idxInAll);
          const dBtn = document.createElement("button");
          dBtn.className = "delete-btn";
          dBtn.textContent = "åˆªé™¤";
          dBtn.onclick = () => deleteRecord(idxInAll);
          actions.appendChild(eBtn);
          actions.appendChild(dBtn);

          div.appendChild(t);
          div.appendChild(actions);
          body.appendChild(div);
        });

        monthCard.appendChild(body);
        box.appendChild(monthCard);
      });
    }

    /* ========= ç·¨è¼¯ç´€éŒ„ ========= */
    function openModal(index) {
      editIndex = index;
      const logs = getLogs();
      const l = logs[index];
      document.getElementById("editDate").value = l.date;
      document.getElementById("editWeight").value = l.weight;
      document.getElementById("editFat").value = l.fat || "";
      document.getElementById("editMuscle").value = l.muscle || "";
      document.getElementById("modalOverlay").style.display = "flex";
    }
    function closeModal() {
      document.getElementById("modalOverlay").style.display = "none";
    }
    function saveEdit() {
      const logs = getLogs();
      const l = logs[editIndex];
      l.date = document.getElementById("editDate").value;
      l.weight = document.getElementById("editWeight").value;
      l.fat = document.getElementById("editFat").value;
      l.muscle = document.getElementById("editMuscle").value;
      if (!l.weight) {
        alert("é«”é‡ä¸å¯ç‚ºç©ºï¼");
        return;
      }
      saveLogs(logs);
      closeModal();
      render();
    }
    function deleteRecord(index) {
      if (!confirm("ç¢ºå®šè¦åˆªé™¤é€™ç­†ç´€éŒ„å—ï¼Ÿ")) return;
      const logs = getLogs();
      logs.splice(index, 1);
      saveLogs(logs);
      render();
    }

    /* ========= è¨­å®šé¢æ¿ ========= */
    function openSettings() {
      const overlay = document.getElementById("settingsOverlay");
      const area = document.getElementById("exportArea");
      const logs = getLogs();
      area.value = JSON.stringify(logs, null, 2);

      const target = getTarget();
      const targetInput = document.getElementById("targetInput");
      const targetHint = document.getElementById("targetHint");
      if (targetInput) targetInput.value = target != null ? target : "";
      if (targetHint)
        targetHint.textContent =
          target != null ? `ç›®å‰ç›®æ¨™é«”é‡ï¼š${target} kg` : "å°šæœªè¨­å®šç›®æ¨™é«”é‡ã€‚";

      const backupBody = document.getElementById("backupBody");
      const toggleBtn = document.getElementById("backupToggleBtn");
      if (backupBody && toggleBtn) {
        backupBody.style.display = "none";
        toggleBtn.textContent = "å±•é–‹";
      }

      updateThemeButtons();
      overlay.style.display = "flex";
    }
    function closeSettings() {
      document.getElementById("settingsOverlay").style.display = "none";
    }

    function toggleBackupSection() {
      const body = document.getElementById("backupBody");
      const btn = document.getElementById("backupToggleBtn");
      if (!body || !btn) return;
      if (body.style.display === "none" || body.style.display === "") {
        body.style.display = "block";
        btn.textContent = "æ”¶åˆ";
      } else {
        body.style.display = "none";
        btn.textContent = "å±•é–‹";
      }
    }

    function saveTargetFromSettings() {
      const input = document.getElementById("targetInput");
      const val = parseFloat(input.value);
      if (!val || isNaN(val)) {
        if (!confirm("æ¸…é™¤ç›®æ¨™é«”é‡è¨­å®šï¼Ÿ")) return;
        setTarget(null);
      } else {
        setTarget(val);
      }
      const targetHint = document.getElementById("targetHint");
      const target = getTarget();
      if (targetHint)
        targetHint.textContent =
          target != null ? `ç›®å‰ç›®æ¨™é«”é‡ï¼š${target} kg` : "å°šæœªè¨­å®šç›®æ¨™é«”é‡ã€‚";
      showTargetInfo();
      renderChart();
      alert("ç›®æ¨™é«”é‡å·²æ›´æ–°");
    }

    function copyExport() {
      const area = document.getElementById("exportArea");
      area.select();
      document.execCommand("copy");
      alert("å·²è¤‡è£½ï¼Œè²¼åˆ°é›²ç«¯è¨˜äº‹æˆ–å‚³çµ¦è‡ªå·±å°±ç®—ã€é›²ç«¯å‚™ä»½ã€äº†ï¼");
    }

    function importFromText() {
      const area = document.getElementById("exportArea");
      const text = area.value.trim();
      if (!text) {
        alert("è«‹å…ˆåœ¨ä¸Šæ–¹è²¼ä¸ŠåŒ¯å‡ºå…§å®¹ï¼");
        return;
      }
      try {
        const data = JSON.parse(text);
        if (!Array.isArray(data)) throw new Error("æ ¼å¼éŒ¯èª¤");
        saveLogs(data);
        alert("åŒ¯å…¥æˆåŠŸï¼Œå·²è¦†è“‹ç›®å‰è³‡æ–™ã€‚");
        render();
      } catch (e) {
        alert("åŒ¯å…¥å¤±æ•—ï¼šæ ¼å¼ä¸æ˜¯æœ‰æ•ˆçš„ JSONã€‚");
      }
    }

    function clearAll() {
      if (!confirm("ç¢ºå®šè¦æ¸…é™¤å…¨éƒ¨ç´€éŒ„å—ï¼Ÿ")) return;
      saveLogs([]);
      render();
    }

    /* ========= Profile / BMI ========= */
    function openProfile() {
      const profile = getProfile();
      document.getElementById("profileHeight").value =
        profile.height != null ? profile.height : "";
      const genderRadios = document.querySelectorAll(
        'input[name="profileGender"]'
      );
      genderRadios.forEach((r) => {
        r.checked = r.value === profile.gender;
      });
      updateProfileBMIText();
      document.getElementById("profileOverlay").style.display = "flex";
    }
    function closeProfile() {
      document.getElementById("profileOverlay").style.display = "none";
    }

    function computeBMI(weightKg, heightCm) {
      if (!weightKg || !heightCm || heightCm <= 0) return null;
      const hM = heightCm / 100;
      return weightKg / (hM * hM);
    }

    function updateProfileBMIText() {
      const profile = getProfile();
      const bmiDiv = document.getElementById("profileBMI");
      const logs = getLogs();
      const pointer = document.getElementById("bmiPointer");
      if (!pointer) return;
      pointer.style.display = "none";

      if (!profile.height || !profile.gender) {
        bmiDiv.textContent =
          "è«‹å…ˆå¡«å¯«èº«é«˜èˆ‡æ€§åˆ¥ï¼Œå„²å­˜å¾Œæœƒä½¿ç”¨æœ€æ–°é«”é‡è¨ˆç®— BMIã€‚";
        return;
      }
      if (!logs.length) {
        bmiDiv.textContent = "ç›®å‰å°šç„¡é«”é‡ç´€éŒ„ï¼Œç„¡æ³•è¨ˆç®— BMIã€‚";
        return;
      }

      const sorted = logs.slice().sort((a, b) => b.date.localeCompare(a.date));
      const last = sorted[0];
      const weight = parseFloat(last.weight);
      const bmi = computeBMI(weight, parseFloat(profile.height));
      if (!bmi) {
        bmiDiv.textContent = "è³‡æ–™ä¸è¶³ï¼Œç„¡æ³•è¨ˆç®— BMIã€‚";
        return;
      }

      const genderText = profile.gender === "male" ? "ç”·" : "å¥³";
      bmiDiv.textContent =
        `æ€§åˆ¥ï¼š${genderText}ï½œèº«é«˜ï¼š${profile.height} cm\n` +
        `ä¾ç…§æœ€æ–°é«”é‡ ${weight} kgï¼ŒBMI ç´„ç‚º ${bmi.toFixed(1)}`;

      const min = 15,
        max = 40;
      let ratio = (bmi - min) / (max - min);
      ratio = Math.max(0, Math.min(1, ratio));
      pointer.style.left = ratio * 100 + "%";
      pointer.style.display = "block";
    }

    function saveProfileData() {
      const heightVal = parseFloat(
        document.getElementById("profileHeight").value
      );
      const genderInput = document.querySelector(
        'input[name="profileGender"]:checked'
      );
      if (!heightVal || isNaN(heightVal) || heightVal <= 0) {
        alert("è«‹è¼¸å…¥æ­£ç¢ºçš„èº«é«˜ï¼ˆcmï¼‰");
        return;
      }
      if (!genderInput) {
        alert("è«‹é¸æ“‡æ€§åˆ¥ï¼ˆç”· / å¥³ï¼‰");
        return;
      }

      const profile = { height: heightVal, gender: genderInput.value };
      saveProfile(profile);
      updateProfileBMIText();
      alert("å·²å„²å­˜å€‹äººè³‡æ–™èˆ‡ BMI è¨­å®š");
      closeProfile();
    }

    /* ========= render ========= */
    function render() {
      renderRecords();
      chartWindowStart = null;
      renderChart();
      showLatest();
      showWeeklyStats();
      showTargetInfo();
    }
  </script>
</body>
</html>